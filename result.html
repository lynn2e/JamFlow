<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JamFlow ğŸ¸ ê²°ê³¼</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCb_CrMi2fc8qB6HvV92DDI77JDmCqGvpY",
      authDomain: "jamflow-dd033.firebaseapp.com",
      databaseURL: "https://jamflow-dd033-default-rtdb.firebaseio.com",
      projectId: "jamflow-dd033",
      storageBucket: "jamflow-dd033.firebasestorage.app",
      messagingSenderId: "913570760402",
      appId: "1:913570760402:web:18450473aa2b0a25b18f0b"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    window._db = db; window._ref = ref;
    window._onValue = onValue; window._set = set;
    document.dispatchEvent(new Event('firebaseReady'));
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#fff; color:#111;
      font-family:'Segoe UI', sans-serif;
      min-height:100vh; display:flex;
      flex-direction:column; align-items:center;
    }
    header {
      width:100%; background:#111;
      padding:16px 24px; display:flex; align-items:center; gap:10px;
    }
    header h1 { color:#fff; font-size:1.4rem; font-weight:800; }
    header h1 span { color:#e8003a; }
    .room-name { color:#aaa; font-size:0.85rem; margin-left:4px; }

    .spinner-wrap {
      margin-top:80px; display:flex;
      flex-direction:column; align-items:center; gap:16px; color:#888;
    }
    .spinner {
      width:36px; height:36px;
      border:3px solid #eee; border-top-color:#e8003a;
      border-radius:50%; animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .main {
      display:none; width:100%; max-width:640px;
      padding:24px 16px 60px; flex-direction:column; gap:24px;
    }

    /* í™•ì • ë°°ë„ˆ */
    .confirmed-banner {
      display:none;
      background:#111; color:#fff;
      border-radius:16px; padding:20px 24px;
      text-align:center;
    }
    .confirmed-banner h2 { font-size:1.2rem; font-weight:800; margin-bottom:6px; }
    .confirmed-banner h2 span { color:#e8003a; }
    .confirmed-banner p { font-size:0.88rem; color:#aaa; }

    /* ì¶”ì²œ ì¹´ë“œ */
    .section-title {
      font-size:1rem; font-weight:800; margin-bottom:12px;
      display:flex; align-items:center; gap:8px;
    }
    .recommend-list { display:flex; flex-direction:column; gap:10px; }
    .recommend-card {
      border:2px solid #eee; border-radius:14px;
      padding:16px 18px; display:flex;
      align-items:center; justify-content:space-between;
      cursor:pointer; transition:border-color 0.2s, box-shadow 0.2s;
    }
    .recommend-card:hover { border-color:#e8003a; box-shadow:3px 3px 0 #e8003a; }
    .recommend-card.top {
      border-color:#e8003a; background:#fff5f7;
      box-shadow:4px 4px 0 #111;
    }
    .recommend-card .info { display:flex; flex-direction:column; gap:4px; }
    .recommend-card .date-text { font-size:1rem; font-weight:800; }
    .recommend-card .time-text { font-size:0.82rem; color:#666; }
    .badge {
      background:#e8003a; color:#fff;
      font-size:0.72rem; font-weight:800;
      padding:4px 10px; border-radius:20px;
      white-space:nowrap;
    }
    .badge.gray { background:#eee; color:#888; }

    /* íˆíŠ¸ë§µ */
    .heatmap-wrap {
      overflow-x:auto;
      border:2px solid #111; border-radius:16px;
      box-shadow:4px 4px 0 #111;
    }
    .heatmap-table { border-collapse:collapse; min-width:100%; }
    .heatmap-table thead th {
      background:#111; color:#fff;
      font-size:0.75rem; font-weight:700;
      padding:10px 4px; text-align:center;
      white-space:nowrap; min-width:44px;
    }
    .heatmap-table thead th:first-child {
      min-width:0; width:0; padding:0;
      position:sticky; left:0; z-index:2;
      border-right:2px solid #333;
    }
    .heatmap-table thead th.sat { color:#7eb8ff; }
    .heatmap-table thead th.sun { color:#ff7eb8; }
    .heatmap-table tbody td.time-label {
      background:#fafafa; font-size:0.65rem; color:#888;
      font-weight:600; padding:0 6px; text-align:right;
      white-space:nowrap; position:sticky; left:0; z-index:1;
      border-right:2px solid #ccc; vertical-align:middle;
    }
    .heatmap-table tbody td.cell {
      width:44px; height:16px;
      border:1px solid #eee;
    }
    .heatmap-table tbody tr.on-the-hour td.cell { border-top:1px solid #ccc; }
    /* í™•ì •ëœ ìŠ¬ë¡¯ ê°•ì¡° */
    .heatmap-table tbody td.cell.confirmed-slot {
      outline:2px solid #111;
      outline-offset:-2px;
    }

    /* ë²”ë¡€ */
    .legend { display:flex; gap:12px; align-items:center; font-size:0.8rem; color:#666; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-dot { width:13px; height:13px; border-radius:3px; border:1px solid #ddd; }

    /* í™•ì • ë²„íŠ¼ */
    .btn-confirm {
      width:100%; padding:16px;
      background:#e8003a; color:#fff;
      border:none; border-radius:12px;
      font-size:1rem; font-weight:700;
      cursor:pointer; box-shadow:4px 4px 0px #111;
      transition:transform 0.15s, box-shadow 0.15s;
    }
    .btn-confirm:active { transform:translate(2px,2px); box-shadow:2px 2px 0px #111; }
    .btn-confirm:disabled { background:#ccc; box-shadow:none; cursor:default; }

    /* ê³µìœ  ë°•ìŠ¤ */
    .share-box {
      display:none;
      border:2px solid #e8003a; border-radius:16px;
      padding:20px; text-align:center; background:#fff5f7;
    }
    .share-box h3 { font-size:1rem; font-weight:800; margin-bottom:8px; }
    .share-box p { font-size:0.85rem; color:#666; margin-bottom:14px; }
    .share-text {
      background:#fff; border:2px dashed #e8003a;
      border-radius:10px; padding:12px 14px;
      font-size:0.88rem; color:#333;
      margin-bottom:14px; line-height:1.6;
      word-break:keep-all;
    }
    .btn-copy {
      background:#111; color:#fff; border:none;
      border-radius:10px; padding:12px 24px;
      font-size:0.9rem; font-weight:700; cursor:pointer;
    }

    /* ì°¸ì—¬ í˜„í™© */
    .member-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .member-chip {
      background:#f5f5f5; border-radius:20px;
      padding:5px 12px; font-size:0.82rem; font-weight:600;
    }
  </style>
</head>
<body>

<header>
  <h1>Jam<span>Flow</span> ğŸ¸</h1>
  <span class="room-name" id="headerRoomName"></span>
</header>

<div class="spinner-wrap" id="loadingScreen">
  <div class="spinner"></div>
  <span>ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
</div>

<div class="main" id="main">

  <!-- í™•ì • ë°°ë„ˆ (í™•ì •ëì„ ë•Œë§Œ í‘œì‹œ) -->
  <div class="confirmed-banner" id="confirmedBanner">
    <h2>ğŸ‰ í•©ì£¼ ë‚ ì§œê°€ <span>í™•ì •</span>ëì–´ìš”!</h2>
    <p id="confirmedText"></p>
  </div>

  <!-- ì¶”ì²œ ì‹œê°„ -->
  <div>
    <div class="section-title">ğŸ† ê²¹ì¹˜ëŠ” ì‹œê°„ ì¶”ì²œ</div>
    <div class="recommend-list" id="recommendList"></div>
  </div>

  <!-- íˆíŠ¸ë§µ -->
  <div>
    <div class="section-title">ğŸ—“ï¸ ì „ì²´ í˜„í™©</div>
    <div class="legend" id="legend"></div>
    <br/>
    <div class="heatmap-wrap">
      <table class="heatmap-table" id="heatmapTable"></table>
    </div>
  </div>

  <!-- ì°¸ì—¬ í˜„í™© -->
  <div>
    <div class="section-title">ğŸ‘¥ ì°¸ì—¬ í˜„í™© <span id="memberCount" style="color:#e8003a; font-weight:400; font-size:0.9rem;"></span></div>
    <div class="member-list" id="memberList"></div>
  </div>

  <!-- í™•ì • ë²„íŠ¼ -->
  <button class="btn-confirm" id="confirmBtn" onclick="confirmSchedule()">
    ğŸ¯ ì´ ì‹œê°„ìœ¼ë¡œ í•©ì£¼ í™•ì •í•˜ê¸°
  </button>

  <!-- ê³µìœ  ë°•ìŠ¤ -->
  <div class="share-box" id="shareBox">
    <h3>ğŸ“¢ ë©¤ë²„ë“¤ì—ê²Œ ê³µìœ í•´ìš”!</h3>
    <p>ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ë‹¨í†¡ë°©ì— ë³´ë‚´ì„¸ìš”</p>
    <div class="share-text" id="shareText"></div>
    <button class="btn-copy" onclick="copyShare()">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
  </div>

</div>

<script>
  const DAYS_FULL = ['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
  const DAYS      = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  const params       = new URLSearchParams(window.location.search);
  const roomId       = params.get('id')        || 'demo_room';
  const roomName     = params.get('name')      || 'í•©ì£¼ë°©';
  const startDate    = params.get('start')     || '2026-02-16';
  const endDate      = params.get('end')       || '2026-02-22';
  const startHour    = parseInt(params.get('startTime') || '9');
  const endHour      = parseInt(params.get('endTime')   || '22');
  const unitMin      = parseInt(params.get('unit')      || '30');
  const totalMembers = parseInt(params.get('members')   || '4');

  document.getElementById('headerRoomName').textContent = roomName;

  function getDates(s, e) {
    const arr = [], cur = new Date(s+'T00:00:00'), end = new Date(e+'T00:00:00');
    while (cur <= end) { arr.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
    return arr;
  }
  function getSlots(sh, eh, unit) {
    const arr = [];
    for (let h = sh; h < eh; h++)
      for (let m = 0; m < 60; m += unit)
        arr.push({ h, m });
    return arr;
  }
  const dates = getDates(startDate, endDate);
  const slots = getSlots(startHour, endHour, unitMin);

  let selections = {};
  let confirmedSlot = null; // { di, si, count }
  let selectedSlot  = null; // ë°©ì¥ì´ í´ë¦­í•´ì„œ ê³ ë¥¸ ìŠ¬ë¡¯

  function cellKey(di, si) { return `${di}_${si}`; }

  function getCount(di, si) {
    return Object.values(selections).filter(s => s && s[cellKey(di,si)]).length;
  }

  function cellColor(di, si) {
    const cnt = getCount(di, si);
    if (cnt === 0) return '#fff';
    if (cnt >= totalMembers) return '#e8003a';
    const r = cnt / totalMembers;
    if (r >= 0.66) return '#ff4d6d';
    if (r >= 0.33) return '#ff8099';
    return '#ffe0e6';
  }

  function timeLabel(h, m) {
    const ampm = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
    const hh   = h === 0 ? 12 : h > 12 ? h-12 : h;
    return m === 0 ? `${ampm} ${hh}ì‹œ` : `${ampm} ${hh}ì‹œ ${m}ë¶„`;
  }

  // â”€â”€ ì¶”ì²œ ì‹œê°„ ê³„ì‚° â”€â”€
  function getTopSlots(n=3) {
    const scored = [];
    dates.forEach((d, di) => {
      slots.forEach((slot, si) => {
        const cnt = getCount(di, si);
        if (cnt > 0) scored.push({ di, si, cnt, d, slot });
      });
    });
    scored.sort((a,b) => b.cnt - a.cnt);

    // ì—°ì†ëœ ìŠ¬ë¡¯ì„ ë¬¶ê¸°
    const groups = [];
    scored.slice(0, 20).forEach(item => {
      const last = groups[groups.length-1];
      if (last && last.di === item.di && item.si === last.endSi+1 && item.cnt === last.cnt) {
        last.endSi = item.si;
      } else {
        groups.push({ ...item, endSi: item.si });
      }
    });
    return groups.slice(0, n);
  }

  function buildRecommend() {
    const tops = getTopSlots(3);
    const list = document.getElementById('recommendList');
    list.innerHTML = '';

    if (tops.length === 0) {
      list.innerHTML = '<p style="color:#aaa; font-size:0.9rem; padding:8px;">ì•„ì§ ì‘ë‹µí•œ ë©¤ë²„ê°€ ì—†ì–´ìš”</p>';
      document.getElementById('confirmBtn').disabled = true;
      return;
    }

    tops.forEach((t, i) => {
      const card = document.createElement('div');
      card.className = 'recommend-card' + (i===0 ? ' top' : '');
      card.dataset.di = t.di;
      card.dataset.si = t.si;

      const d     = t.d;
      const dateStr = `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ${DAYS_FULL[d.getDay()]}`;
      const startT  = timeLabel(t.slot.h, t.slot.m);
      const endSlot = slots[t.endSi] || t.slot;
      const endH    = t.endSi < slots.length-1 ? slots[t.endSi+1].h : endSlot.h;
      const endM    = t.endSi < slots.length-1 ? slots[t.endSi+1].m : (endSlot.m + unitMin) % 60;
      const endT    = timeLabel(endH, endM);

      card.innerHTML = `
        <div class="info">
          <div class="date-text">${dateStr}</div>
          <div class="time-text">${startT} ~ ${endT}</div>
        </div>
        <div class="badge ${i===0?'':'gray'}">${t.cnt}ëª… ê°€ëŠ¥${t.cnt>=totalMembers?' ğŸ‰':''}</div>
      `;
      card.addEventListener('click', () => selectSlot(t, card));
      list.appendChild(card);
    });

    // ê¸°ë³¸ìœ¼ë¡œ 1ìœ„ ì„ íƒ
    if (tops[0]) selectSlot(tops[0], list.firstChild);
  }

  function selectSlot(t, card) {
    document.querySelectorAll('.recommend-card').forEach(c => c.classList.remove('top'));
    card.classList.add('top');
    selectedSlot = t;
  }

  // â”€â”€ íˆíŠ¸ë§µ â”€â”€
  function buildHeatmap() {
    const tbl = document.getElementById('heatmapTable');
    tbl.innerHTML = '';
    const thead = tbl.createTHead(), hrow = thead.insertRow();
    const th0 = document.createElement('th'); hrow.appendChild(th0);
    dates.forEach((d, di) => {
      const th = document.createElement('th');
      const day = d.getDay();
      th.innerHTML = `${d.getMonth()+1}/${d.getDate()}<br/>${DAYS[day]}`;
      if (day===6) th.classList.add('sat');
      if (day===0) th.classList.add('sun');
      hrow.appendChild(th);
    });

    const tbody = tbl.createTBody();
    slots.forEach((slot, si) => {
      const tr = tbody.insertRow();
      if (slot.m===0) tr.classList.add('on-the-hour');
      const td0 = tr.insertCell();
      td0.className = 'time-label';
      if (slot.m===0) td0.textContent = timeLabel(slot.h, 0);
      dates.forEach((d, di) => {
        const td = tr.insertCell();
        td.className = 'cell';
        td.dataset.di = di; td.dataset.si = si;
        td.style.background = cellColor(di, si);
        if (confirmedSlot && confirmedSlot.di===di && si>=confirmedSlot.si && si<=confirmedSlot.endSi) {
          td.classList.add('confirmed-slot');
        }
      });
    });
  }

  // â”€â”€ ë²”ë¡€ â”€â”€
  function buildLegend() {
    const m = totalMembers;
    const items = [
      { color:'#fff',    label:'ë¶ˆê°€' },
      { color:'#ffe0e6', label:'1ëª…' },
      { color:'#ff8099', label: m<=4 ? '2ëª…' : `2~${Math.floor(m*0.66)}ëª…` },
      { color:'#ff4d6d', label: m<=4 ? '3ëª…' : `${Math.floor(m*0.66)+1}~${m-1}ëª…` },
      { color:'#e8003a', label:`${m}ëª… ëª¨ë‘!` },
    ];
    document.getElementById('legend').innerHTML = items.map(i =>
      `<div class="legend-item">
        <div class="legend-dot" style="background:${i.color};"></div>
        <span>${i.label}</span>
      </div>`
    ).join('');
  }

  // â”€â”€ ì°¸ì—¬ í˜„í™© â”€â”€
  function buildMembers() {
    const names = Object.keys(selections).filter(n => {
      const s = selections[n]; return s && Object.keys(s).length > 0;
    });
    document.getElementById('memberCount').textContent = `${names.length}ëª… ì°¸ì—¬`;
    document.getElementById('memberList').innerHTML = names.map(n =>
      `<div class="member-chip">${n}</div>`
    ).join('');
  }

  // â”€â”€ í•©ì£¼ í™•ì • â”€â”€
  function confirmSchedule() {
    if (!selectedSlot) { alert('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    const t = selectedSlot;
    const d = t.d;
    const dateStr  = `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ ${DAYS_FULL[d.getDay()]}`;
    const startT   = timeLabel(t.slot.h, t.slot.m);
    const endSlot  = slots[t.endSi] || t.slot;
    const endH     = t.endSi < slots.length-1 ? slots[t.endSi+1].h : endSlot.h;
    const endM     = t.endSi < slots.length-1 ? slots[t.endSi+1].m : (endSlot.m+unitMin)%60;
    const endT     = timeLabel(endH, endM);
    const fullText = `${dateStr} ${startT} ~ ${endT}`;

    if (!confirm(`"${fullText}"ìœ¼ë¡œ í•©ì£¼ë¥¼ í™•ì •í• ê¹Œìš”?`)) return;

    confirmedSlot = t;

    // Firebaseì— ì €ì¥
    if (window._db) {
      window._set(window._ref(window._db, `rooms/${roomId}/confirmed`), {
        di: t.di, si: t.si, endSi: t.endSi,
        text: fullText
      });
    }

    showConfirmed(fullText);
  }

  function showConfirmed(text) {
    document.getElementById('confirmedBanner').style.display = 'block';
    document.getElementById('confirmedText').textContent = text;
    document.getElementById('confirmBtn').disabled = true;
    document.getElementById('confirmBtn').textContent = 'âœ… í™•ì • ì™„ë£Œ!';

    // ê³µìœ  í…ìŠ¤íŠ¸ ìƒì„±
    const shareMsg = `ğŸ¸ ${roomName} í•©ì£¼ ë‚ ì§œ í™•ì •!\n\nğŸ“… ${text}\n\nëª¨ë‘ ì°¸ì„ ë¶€íƒë“œë ¤ìš” ğŸ™`;
    document.getElementById('shareText').textContent = shareMsg;
    document.getElementById('shareBox').style.display = 'block';

    buildHeatmap(); // í™•ì • ìŠ¬ë¡¯ í•˜ì´ë¼ì´íŠ¸ ë°˜ì˜
    document.getElementById('confirmedBanner').scrollIntoView({ behavior:'smooth', block:'center' });
  }

  function copyShare() {
    const text = document.getElementById('shareText').textContent;
    navigator.clipboard.writeText(text).then(() => alert('âœ… ë³µì‚¬ëì–´ìš”! ë‹¨í†¡ë°©ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš” ğŸ¶'))
    .catch(() => {
      const el = document.createElement('textarea');
      el.value = text; document.body.appendChild(el);
      el.select(); document.execCommand('copy');
      document.body.removeChild(el);
      alert('âœ… ë³µì‚¬ëì–´ìš”!');
    });
  }

  // â”€â”€ Firebase ë°ì´í„° ìˆ˜ì‹  â”€â”€
  function loadData() {
    if (!window._db) { renderAll(); return; }

    window._onValue(window._ref(window._db, `rooms/${roomId}`), snap => {
      const data = snap.val() || {};
      selections = data.selections || {};

      // ì´ë¯¸ í™•ì •ëœ ê²½ìš°
      if (data.confirmed) {
        confirmedSlot = data.confirmed;
        showConfirmed(data.confirmed.text);
      }
      renderAll();
    });
  }

  function renderAll() {
    buildLegend();
    buildRecommend();
    buildHeatmap();
    buildMembers();
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('main').style.display = 'flex';
  }

  if (window._db) {
    loadData();
  } else {
    document.addEventListener('firebaseReady', loadData);
    setTimeout(() => {
      if (document.getElementById('loadingScreen').style.display !== 'none') {
        loadData();
      }
    }, 3000);
  }
</script>
</body>
</html>
