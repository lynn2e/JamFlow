<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JamFlow ğŸ¸</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#fff; color:#111; font-family:'Segoe UI',sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center; }

    header { width:100%; background:#111; padding:16px 24px; display:flex; align-items:center; gap:10px; }
    header h1 { color:#fff; font-size:1.4rem; font-weight:800; }
    header h1 span { color:#e8003a; }
    .room-name { color:#aaa; font-size:0.85rem; margin-left:4px; }

    .spinner-wrap { margin-top:80px; display:flex; flex-direction:column; align-items:center; gap:16px; color:#888; }
    .spinner { width:36px; height:36px; border:3px solid #eee; border-top-color:#e8003a; border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .name-screen { width:100%; max-width:480px; padding:48px 24px; display:none; flex-direction:column; align-items:center; gap:16px; text-align:center; }
    .name-screen h2 { font-size:1.4rem; font-weight:800; line-height:1.4; }
    .name-screen h2 span { color:#e8003a; }
    .name-screen p { font-size:0.9rem; color:#666; }
    .name-card { width:100%; border:2px solid #111; border-radius:20px; padding:24px; box-shadow:6px 6px 0px #111; margin-top:8px; }
    .name-card label { display:block; font-size:0.85rem; font-weight:600; margin-bottom:8px; }
    .name-card input { width:100%; padding:12px 14px; border:2px solid #ddd; border-radius:10px; font-size:1rem; background:#fafafa; margin-bottom:16px; transition:border-color 0.2s; }
    .name-card input:focus { outline:none; border-color:#e8003a; background:#fff; }

    .btn-main { width:100%; padding:16px; background:#e8003a; color:#fff; border:none; border-radius:12px; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:4px 4px 0px #111; transition:transform 0.15s, box-shadow 0.15s; }
    .btn-main:active { transform:translate(2px,2px); box-shadow:2px 2px 0px #111; }

    .main-screen { display:none; width:100%; max-width:640px; padding:20px 16px 60px; flex-direction:column; gap:20px; }

    .top-bar { display:flex; justify-content:space-between; align-items:center; }
    .top-bar h2 { font-size:1rem; font-weight:800; }
    .user-badge { background:#111; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.8rem; font-weight:700; }

    /* ì£¼ ë„¤ë¹„ê²Œì´ì…˜ */
    .week-nav { display:flex; align-items:center; justify-content:space-between; background:#f5f5f5; border-radius:12px; padding:10px 14px; }
    .week-nav .week-label { font-size:0.9rem; font-weight:700; text-align:center; flex:1; }
    .week-nav .week-label span { color:#e8003a; }
    .btn-week { background:#fff; border:2px solid #ddd; border-radius:8px; padding:6px 14px; font-size:0.85rem; font-weight:700; cursor:pointer; transition:border-color 0.15s; }
    .btn-week:hover { border-color:#e8003a; color:#e8003a; }
    .btn-week:disabled { opacity:0.3; cursor:default; }

    .legend { display:flex; gap:12px; align-items:center; font-size:0.8rem; color:#666; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-dot { width:13px; height:13px; border-radius:3px; border:1px solid #ddd; }

    .grid-wrap { overflow-x:auto; border:2px solid #111; border-radius:16px; box-shadow:4px 4px 0 #111; }
    .grid-table { border-collapse:collapse; width:100%; }
    .grid-table thead th { background:#111; color:#fff; font-size:0.75rem; font-weight:700; padding:10px 4px; text-align:center; white-space:nowrap; }
    .grid-table thead th:first-child { min-width:0; width:52px; position:sticky; left:0; z-index:2; border-right:2px solid #333; }
    .grid-table thead th.sat { color:#7eb8ff; }
    .grid-table thead th.sun { color:#ff7eb8; }
    .grid-table tbody td.time-label { background:#fafafa; font-size:0.65rem; color:#888; font-weight:600; padding:0 6px; text-align:right; white-space:nowrap; position:sticky; left:0; z-index:1; border-right:2px solid #ccc; vertical-align:middle; width:52px; }
    .grid-table tbody td.cell { height:16px; border:1px solid #eee; cursor:pointer; user-select:none; }
    .grid-table tbody td.cell.mine { outline:2px solid #e8003a; outline-offset:-2px; z-index:1; position:relative; }
    .grid-table tbody tr.on-the-hour td.cell { border-top:1px solid #ccc; }

    .recommend-box { border:2px solid #111; border-radius:16px; padding:20px; box-shadow:4px 4px 0 #111; }
    .recommend-box h3 { font-size:0.95rem; font-weight:800; margin-bottom:14px; }
    .recommend-list { display:flex; flex-direction:column; gap:10px; }
    .rec-card { border:2px solid #eee; border-radius:12px; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; transition:border-color 0.15s; }
    .rec-card:hover { border-color:#e8003a; }
    .rec-card.top { border-color:#e8003a; background:#fff5f7; box-shadow:4px 4px 0 #111; }
    .rec-card .crown { font-size:0.8rem; margin-right:4px; }
    .rec-card .info .date-text { font-size:0.95rem; font-weight:800; }
    .rec-card .info .time-text { font-size:0.8rem; color:#666; margin-top:2px; }
    .badge { background:#e8003a; color:#fff; font-size:0.72rem; font-weight:800; padding:4px 10px; border-radius:20px; white-space:nowrap; }
    .badge.gray { background:#eee; color:#888; }
    .no-overlap { font-size:0.88rem; color:#aaa; text-align:center; padding:12px 0; }

    .status-card { border:2px solid #eee; border-radius:14px; padding:16px 20px; }
    .status-card h3 { font-size:0.9rem; font-weight:700; margin-bottom:12px; }
    .member-list { display:flex; flex-wrap:wrap; gap:8px; }
    .member-chip { background:#f5f5f5; border-radius:20px; padding:5px 12px; font-size:0.82rem; font-weight:600; cursor:pointer; transition: all 0.15s; }
    .member-chip:hover { border-color:#111; background:#eee; }
    .member-chip.me { background:#fff0f3; color:#e8003a; border:1.5px solid #e8003a; cursor:default; }
    .member-chip.active { background:#111; color:#fff; }

    .confirm-section { display:flex; flex-direction:column; gap:8px; }
    .confirm-desc { font-size:0.82rem; color:#aaa; text-align:center; }
    .btn-confirm { width:100%; padding:16px; background:#111; color:#fff; border:none; border-radius:12px; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:4px 4px 0px #e8003a; transition:transform 0.15s, box-shadow 0.15s; }
    .btn-confirm:active { transform:translate(2px,2px); box-shadow:2px 2px 0px #e8003a; }
    .btn-confirm:disabled { background:#ccc; box-shadow:none; cursor:default; }

    .confirmed-banner { display:none; background:#111; color:#fff; border-radius:16px; padding:20px 24px; text-align:center; }
    .confirmed-banner h3 { font-size:1.1rem; font-weight:800; margin-bottom:6px; }
    .confirmed-banner h3 span { color:#e8003a; }
    .confirmed-banner p { font-size:0.88rem; color:#aaa; margin-bottom:14px; }
    .share-text { background:#1a1a1a; border-radius:10px; padding:12px 14px; font-size:0.85rem; color:#fff; line-height:1.6; margin-bottom:14px; word-break:keep-all; text-align:left; }
    .btn-copy { background:#e8003a; color:#fff; border:none; border-radius:10px; padding:12px 24px; font-size:0.9rem; font-weight:700; cursor:pointer; }

    .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:12px 20px; border-radius:12px; font-size:0.88rem; font-weight:600; box-shadow:0 4px 16px rgba(0,0,0,0.2); opacity:0; transition:opacity 0.3s; pointer-events:none; z-index:999; white-space:nowrap; }
    .toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <h1>Jam<span>Flow</span> ğŸ¸</h1>
  <span class="room-name" id="headerRoomName"></span>
</header>

<div class="spinner-wrap" id="loadingScreen">
  <div class="spinner"></div>
  <span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
</div>

<div class="name-screen" id="nameScreen">
  <div style="font-size:3rem">ğŸµ</div>
  <h2 id="roomTitle">í•©ì£¼ ì‹œê°„ì„<br/><span>ê°™ì´ ë§ì¶°ë´ìš”</span></h2>
  <p>ë¡œê·¸ì¸ ì—†ì´ ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”</p>
  <div class="name-card">
    <label>ë‚´ ì´ë¦„ (ë‹‰ë„¤ì„)</label>
    <input type="text" id="userName" placeholder="ì˜ˆ: ê¹€ê¸°íƒ€, ë² ì´ìŠ¤ìµœ" maxlength="10"/>
    <button class="btn-main" id="enterBtn">ğŸ¸ ì°¸ì—¬í•˜ê¸°</button>
  </div>
</div>

<div class="main-screen" id="mainScreen">

  <div class="top-bar">
    <h2>ê°€ëŠ¥í•œ ì‹œê°„ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ìš”</h2>
    <div class="user-badge" id="userBadge"></div>
  </div>

  <!-- ì£¼ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div class="week-nav">
    <button class="btn-week" id="prevWeekBtn">â† ì´ì „ ì£¼</button>
    <div class="week-label" id="weekLabel"></div>
    <button class="btn-week" id="nextWeekBtn">ë‹¤ìŒ ì£¼ â†’</button>
  </div>

  <div class="legend" id="legend"></div>

  <div class="grid-wrap">
    <table class="grid-table" id="gridTable"></table>
  </div>

  <div class="status-card">
    <h3>ğŸ‘¥ ì°¸ì—¬ í˜„í™© <span id="memberCount" style="color:#e8003a;"></span></h3>
    <div class="member-list" id="memberList"></div>
  </div>

  <!-- ì¶”ì²œ -->
  <div class="recommend-box">
    <h3>ğŸ† ì§€ê¸ˆ ê°€ì¥ ë§ì´ ê²¹ì¹˜ëŠ” ì‹œê°„</h3>
    <div class="recommend-list" id="recommendList"></div>
  </div>



</div>

<div class="toast" id="toast"></div>

<script>
  var DAYS_FULL = ['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
  var DAYS      = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  var params       = new URLSearchParams(window.location.search);
  var roomId       = params.get('id')        || 'demo_room';
  var roomName     = params.get('name')      || 'í•©ì£¼ë°©';
  var startDate    = params.get('start')     || '2026-02-16';
  var endDate      = params.get('end')       || '2026-02-22';
  var startHour    = parseInt(params.get('startTime') || '9');
  var endHour      = parseInt(params.get('endTime')   || '22');
  var unitMin      = parseInt(params.get('unit')      || '30');
  var totalMembers = parseInt(params.get('members')   || '4');
  var myName       = '';
  var currentWeek  = 0; // í˜„ì¬ ë³´ì—¬ì£¼ëŠ” ì£¼ ì¸ë±ìŠ¤

  document.getElementById('headerRoomName').textContent = roomName;
  document.getElementById('roomTitle').innerHTML = '<span>'+roomName+'</span><br/>í•©ì£¼ ì‹œê°„ì„ ê°™ì´ ë§ì¶°ë´ìš”';

  // ì „ì²´ ë‚ ì§œ ë°°ì—´
  function getDates(s, e) {
    var arr = [], cur = new Date(s+'T00:00:00'), end = new Date(e+'T00:00:00');
    while (cur <= end) { arr.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
    return arr;
  }
  // ì£¼ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ê¸°
  function splitWeeks(dates) {
    var weeks = [], week = [];
    for (var i=0; i<dates.length; i++) {
      week.push(dates[i]);
      if (week.length === 7 || i === dates.length-1) {
        weeks.push(week);
        week = [];
      }
    }
    return weeks;
  }
  function getSlots(sh, eh, unit) {
    var arr = [];
    for (var h=sh; h<eh; h++)
      for (var m=0; m<60; m+=unit)
        arr.push({h:h, m:m});
    return arr;
  }

  var allDates = getDates(startDate, endDate);
  var weeks    = splitWeeks(allDates);
  var slots    = getSlots(startHour, endHour, unitMin);

  var selections   = {};
  var isDragging   = false;
  var dragMode     = null;
  var saveTimer    = null;
  var selectedRec  = null;
  var viewingMember = null; // í˜„ì¬ ë³´ê³  ìˆëŠ” ë©¤ë²„ (nullì´ë©´ ì „ì²´)

  function cellKey(di, si) { return di+'_'+si; }
  function getCount(di, si) {
    var k = cellKey(di,si), cnt=0, names=Object.keys(selections);
    for (var i=0; i<names.length; i++)
      if (selections[names[i]] && selections[names[i]][k]) cnt++;
    return cnt;
  }
  function isMine(di, si) { return !!(selections[myName] && selections[myName][cellKey(di,si)]); }
  // ë‚¨ë“¤ë§Œ ì„ íƒí•œ ì¹¸ ìƒ‰ìƒ (íšŒìƒ‰ ê³„ì—´)
  function othersColor(cnt) {
    if (cnt === 0) return '#fff';
    var r = cnt / totalMembers;
    if (r >= 0.66) return '#bbb';
    if (r >= 0.33) return '#d5d5d5';
    return '#eeeeee';
  }

  function cellColor(di, si) {
    var cnt = getCount(di, si);
    if (cnt === 0) return '#fff';
    var mine = isMine(di, si);
    var others = cnt - (mine ? 1 : 0);
    if (mine && others > 0) {
      // ë‚˜ + ë‹¤ë¥¸ ì‚¬ëŒ ê²¹ì¹¨ â†’ ì§„í•œ ë¹¨ê°•
      var r = cnt / totalMembers;
      if (r >= 0.66) return '#ff4d6d';
      if (r >= 0.33) return '#ff8099';
      return '#ffb3c1';
    }
    if (mine) return '#ffe0e6'; // ë‚˜ë§Œ ì„ íƒ
    return othersColor(others); // ë‚¨ë“¤ë§Œ ì„ íƒ
  }
  function timeLabel(h, m) {
    var ap = h<12?'ì˜¤ì „':'ì˜¤í›„', hh = h===0?12:h>12?h-12:h;
    return m===0 ? ap+' '+hh+'ì‹œ' : ap+' '+hh+'ì‹œ '+m+'ë¶„';
  }

  // í† ìŠ¤íŠ¸
  var toastTimer = null;
  function showToast(msg, dur) {
    var el = document.getElementById('toast');
    el.textContent = msg; el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function(){ el.classList.remove('show'); }, dur||2000);
  }

  // ë²”ë¡€
  function buildLegend() {
    var m = totalMembers;
    var items = [
      {color:'#fff',    label:'ë¶ˆê°€'},
      {color:'#ffe0e6', label:'1ëª…'},
      {color:'#ff8099', label: m<=4?'2ëª…':'2~'+Math.floor(m*0.66)+'ëª…'},
      {color:'#ff4d6d', label: m<=4?'3ëª…':(Math.floor(m*0.66)+1)+'~'+(m-1)+'ëª…'},
      {color:'#e8003a', label: m+'ëª… ëª¨ë‘!'},
    ];
    var html='';
    for (var i=0;i<items.length;i++)
      html+='<div class="legend-item"><div class="legend-dot" style="background:'+items[i].color+'"></div><span>'+items[i].label+'</span></div>';
    document.getElementById('legend').innerHTML = html;
  }

  // ì£¼ ë„¤ë¹„ ì—…ë°ì´íŠ¸
  function updateWeekNav() {
    var w = weeks[currentWeek];
    var first = w[0], last = w[w.length-1];
    var label = (first.getMonth()+1)+'ì›” '+first.getDate()+'ì¼ ~ '+(last.getMonth()+1)+'ì›” '+last.getDate()+'ì¼';
    if (weeks.length > 1) label += ' <span>('+(currentWeek+1)+'/'+weeks.length+'ì£¼)</span>';
    document.getElementById('weekLabel').innerHTML = label;
    document.getElementById('prevWeekBtn').disabled = currentWeek === 0;
    document.getElementById('nextWeekBtn').disabled = currentWeek === weeks.length-1;
    weeks.length <= 1
      ? document.querySelector('.week-nav').style.display = 'none'
      : document.querySelector('.week-nav').style.display = 'flex';
  }

  // ê·¸ë¦¬ë“œ (í˜„ì¬ ì£¼ë§Œ)
  function buildGrid() {
    var w = weeks[currentWeek];
    // í˜„ì¬ ì£¼ì˜ ë‚ ì§œë“¤ì´ allDatesì—ì„œ ëª‡ ë²ˆì§¸ì¸ì§€ ê³„ì‚°
    var weekStartDi = 0;
    for (var i=0; i<allDates.length; i++) {
      if (allDates[i].getTime() === w[0].getTime()) { weekStartDi = i; break; }
    }

    var tbl = document.getElementById('gridTable');
    tbl.innerHTML = '';
    var thead = tbl.createTHead(), hrow = thead.insertRow();
    var th0 = document.createElement('th'); hrow.appendChild(th0);
    for (var di=0; di<w.length; di++) {
      var d = w[di], day = d.getDay();
      var th = document.createElement('th');
      th.innerHTML = (d.getMonth()+1)+'/'+(d.getDate())+'<br/>'+DAYS[day];
      if (day===6) th.classList.add('sat');
      if (day===0) th.classList.add('sun');
      hrow.appendChild(th);
    }
    var tbody = tbl.createTBody();
    for (var si=0; si<slots.length; si++) {
      var slot = slots[si];
      var tr = tbody.insertRow();
      if (slot.m===0) tr.classList.add('on-the-hour');
      var td0 = tr.insertCell(); td0.className='time-label';
      if (slot.m===0) td0.textContent = timeLabel(slot.h,0);
      for (var di2=0; di2<w.length; di2++) {
        var realDi = weekStartDi + di2;
        var td = tr.insertCell();
        td.className='cell';
        td.dataset.di = realDi; td.dataset.si = si;
        td.style.background = cellColor(realDi, si);
        (function(rdi, sii) {
          td.addEventListener('mousedown', function(e){ e.preventDefault(); startDrag(rdi,sii); });
          td.addEventListener('mouseover', function(){ if(isDragging) doDrag(rdi,sii); });
          td.addEventListener('touchstart', function(e){ e.preventDefault(); startDrag(rdi,sii); },{passive:false});
          td.addEventListener('touchmove', function(e){
            e.preventDefault();
            var t=e.touches[0], el=document.elementFromPoint(t.clientX,t.clientY);
            if(el&&el.dataset.di!==undefined) doDrag(parseInt(el.dataset.di),parseInt(el.dataset.si));
          },{passive:false});
        })(realDi, si);
      }
    }
    document.addEventListener('mouseup',  function(){ if(isDragging){ isDragging=false; scheduleSave(); updateRecommend(); updateStatus(); }});
    document.addEventListener('touchend', function(){ if(isDragging){ isDragging=false; scheduleSave(); updateRecommend(); updateStatus(); }});
  }

  function startDrag(di,si){ isDragging=true; dragMode=isMine(di,si)?'remove':'add'; toggle(di,si); }
  function doDrag(di,si){
    if(dragMode==='add'&&!isMine(di,si)) toggle(di,si);
    if(dragMode==='remove'&&isMine(di,si)) toggle(di,si);
  }
  function toggle(di,si){
    if(!selections[myName]) selections[myName]={};
    var k=cellKey(di,si);
    if(dragMode==='add') selections[myName][k]=true;
    else delete selections[myName][k];
    var td=document.querySelector('td[data-di="'+di+'"][data-si="'+si+'"]');
    if(td){
      td.style.background=cellColor(di,si);
      if(isMine(di,si)) td.classList.add('mine');
      else td.classList.remove('mine');
    }
    updateRecommend();
  }

  // ì£¼ ì „í™˜
  document.getElementById('prevWeekBtn').addEventListener('click', function(){
    if(currentWeek>0){ currentWeek--; updateWeekNav(); buildGrid(); }
  });
  document.getElementById('nextWeekBtn').addEventListener('click', function(){
    if(currentWeek<weeks.length-1){ currentWeek++; updateWeekNav(); buildGrid(); }
  });

  // ì¶”ì²œ
  function updateRecommend() {
    var scored=[];
    for(var di=0;di<allDates.length;di++)
      for(var si=0;si<slots.length;si++){
        var cnt=getCount(di,si);
        if(cnt>0) scored.push({di:di,si:si,cnt:cnt,endSi:si});
      }
    scored.sort(function(a,b){ return b.cnt-a.cnt; });
    var groups=[];
    for(var i=0;i<Math.min(scored.length,30);i++){
      var item=scored[i], last=groups[groups.length-1];
      if(last&&last.di===item.di&&item.si===last.endSi+1&&item.cnt===last.cnt) last.endSi=item.si;
      else groups.push({di:item.di,si:item.si,endSi:item.si,cnt:item.cnt});
    }
    groups=groups.slice(0,3);

    var list=document.getElementById('recommendList');
    if(groups.length===0){
      list.innerHTML='<div class="no-overlap">ì•„ì§ ì•„ë¬´ë„ ì„ íƒí•˜ì§€ ì•Šì•˜ì–´ìš”</div>';
      selectedRec=null; return;
    }
    var html='';
    for(var j=0;j<groups.length;j++){
      var g=groups[j], d=allDates[g.di];
      var dateStr=(d.getMonth()+1)+'ì›” '+d.getDate()+'ì¼ '+DAYS_FULL[d.getDay()];
      var startT=timeLabel(slots[g.si].h,slots[g.si].m);
      var nsi=g.endSi+1;
      var endT=nsi<slots.length?timeLabel(slots[nsi].h,slots[nsi].m):timeLabel(slots[g.endSi].h,slots[g.endSi].m+unitMin);
      html+='<div class="rec-card'+(j===0?' top':'')+'">'
        +'<div class="info"><div class="date-text">'+(j===0?'ğŸ‘‘ ':'')+dateStr+'</div><div class="time-text">'+startT+' ~ '+endT+'</div></div>'
        +'<div class="badge '+(j===0?'':'gray')+'">'+g.cnt+'ëª…'+(g.cnt>=totalMembers?' ğŸ‰':'')+'</div>'
        +'</div>';
    }
    list.innerHTML=html;
  }

  function updateStatus(){
    var names=Object.keys(selections).filter(function(n){ var s=selections[n]; return s&&Object.keys(s).length>0; });
    document.getElementById('memberCount').textContent=names.length+'ëª… ì°¸ì—¬ì¤‘';
    var html='';
    for(var i=0;i<names.length;i++){
      var n=names[i];
      var isMe = n===myName;
      var isActive = viewingMember===n;
      html+='<div class="member-chip'+(isMe?' me':isActive?' active':'')+'" data-name="'+n+'">'
        +n+(isMe?' (ë‚˜)':'')
        +'</div>';
    }
    document.getElementById('memberList').innerHTML=html;

    // ë©¤ë²„ ì¹© í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.member-chip:not(.me)').forEach(function(chip) {
      chip.addEventListener('click', function() {
        var name = chip.dataset.name;
        if (viewingMember === name) {
          // ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì „ì²´ ë³´ê¸°ë¡œ ë³µê·€
          viewingMember = null;
          showToast('ì „ì²´ ë³´ê¸°ë¡œ ëŒì•„ì™”ì–´ìš”', 1500);
        } else {
          viewingMember = name;
          showToast('ğŸ‘€ '+name+'ì˜ ìŠ¤ì¼€ì¤„ ë³´ëŠ” ì¤‘', 1500);
        }
        refreshAllCells();
        updateStatus();
      });
    });
  }

  // Firebase ì´ˆê¸°í™”
  try {
    firebase.initializeApp({
      apiKey: "AIzaSyCb_CrMi2fc8qB6HvV92DDI77JDmCqGvpY",
      authDomain: "jamflow-dd033.firebaseapp.com",
      databaseURL: "https://jamflow-dd033-default-rtdb.firebaseio.com",
      projectId: "jamflow-dd033",
      storageBucket: "jamflow-dd033.firebasestorage.app",
      messagingSenderId: "913570760402",
      appId: "1:913570760402:web:18450473aa2b0a25b18f0b"
    });
    window._firebaseDb      = firebase.database();
    window._firebaseRef     = function(db, path){ return db.ref(path); };
    window._firebaseSet     = function(ref, val){ return ref.set(val); };
    window._firebaseOnValue = function(ref, cb){ ref.on('value', cb); };
    console.log('Firebase ì—°ê²° ì„±ê³µ!');
  } catch(e) {
    console.log('Firebase ì—°ê²° ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):', e);
  }
    clearTimeout(saveTimer);
    saveTimer=setTimeout(saveToFirebase, 2000);
  }
  function saveToFirebase(){
    if(window._firebaseDb){
      window._firebaseSet(window._firebaseRef(window._firebaseDb,'rooms/'+roomId+'/selections/'+myName),selections[myName]||{})
        .then(function(){ showToast('âœ… ì €ì¥ëì–´ìš”!'); })
        .catch(function(){ showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨'); });
    } else { showToast('âœ… ì €ì¥ëì–´ìš”!'); }
    updateStatus();
  }

  function refreshAllCells(){
    var cells=document.querySelectorAll('td.cell');
    for(var i=0;i<cells.length;i++){
      var di=parseInt(cells[i].dataset.di), si=parseInt(cells[i].dataset.si);
      if (viewingMember) {
        var sel=selections[viewingMember];
        cells[i].style.background=(sel&&sel[cellKey(di,si)])?'#e8003a':'#fff';
        cells[i].classList.remove('mine');
      } else {
        cells[i].style.background=cellColor(di,si);
        if(isMine(di,si)) cells[i].classList.add('mine');
        else cells[i].classList.remove('mine');
      }
    }
  }

  function listenFirebase(){
    if(!window._firebaseDb) return;
    window._firebaseOnValue(window._firebaseRef(window._firebaseDb,'rooms/'+roomId),function(snap){
      var data=snap.val()||{}, remote=data.selections||{};
      Object.keys(remote).forEach(function(name){ if(name!==myName) selections[name]=remote[name]; });
      if(data.confirmed&&!confirmedData){ confirmedData=data.confirmed; showConfirmed(data.confirmed.text); }
      refreshAllCells(); updateStatus(); updateRecommend();
    });
  }

  document.getElementById('confirmBtn').addEventListener('click',function(){
    if(!selectedRec){ alert('ì¶”ì²œ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }
    var g=selectedRec, d=allDates[g.di];
    var dateStr=(d.getMonth()+1)+'ì›” '+d.getDate()+'ì¼ '+DAYS_FULL[d.getDay()];
    var startT=timeLabel(slots[g.si].h,slots[g.si].m);
    var nsi=g.endSi+1;
    var endT=nsi<slots.length?timeLabel(slots[nsi].h,slots[nsi].m):timeLabel(slots[g.endSi].h,slots[g.endSi].m+unitMin);
    var fullText=dateStr+' '+startT+' ~ '+endT;
    if(!confirm('"'+fullText+'"ìœ¼ë¡œ í•©ì£¼ë¥¼ í™•ì •í• ê¹Œìš”?')) return;
    if(window._firebaseDb)
      window._firebaseSet(window._firebaseRef(window._firebaseDb,'rooms/'+roomId+'/confirmed'),{di:g.di,si:g.si,endSi:g.endSi,text:fullText});
    showConfirmed(fullText);
  });

  function showConfirmed(text){
    confirmedData={text:text};
    document.getElementById('confirmedBanner').style.display='block';
    document.getElementById('confirmedText').textContent=text;
    document.getElementById('confirmBtn').disabled=true;
    document.getElementById('confirmBtn').textContent='âœ… í™•ì • ì™„ë£Œ!';
    var msg='ğŸ¸ '+roomName+' í•©ì£¼ ë‚ ì§œ í™•ì •!\n\nğŸ“… '+text+'\n\nëª¨ë‘ ì°¸ì„ ë¶€íƒë“œë ¤ìš” ğŸ™';
    document.getElementById('shareText').textContent=msg;
    document.getElementById('confirmedBanner').scrollIntoView({behavior:'smooth',block:'center'});
  }

  document.getElementById('copyBtn').addEventListener('click',function(){
    var text=document.getElementById('shareText').textContent;
    navigator.clipboard.writeText(text).then(function(){ alert('âœ… ë³µì‚¬ëì–´ìš”! ë‹¨í†¡ë°©ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš” ğŸ¶'); })
    .catch(function(){
      var el=document.createElement('textarea'); el.value=text; document.body.appendChild(el);
      el.select(); document.execCommand('copy'); document.body.removeChild(el);
      alert('âœ… ë³µì‚¬ëì–´ìš”!');
    });
  });

  // ì°¸ì—¬í•˜ê¸°
  document.getElementById('enterBtn').addEventListener('click',function(){
    var name=document.getElementById('userName').value.trim();
    if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
    enterWithName(name);
  });
  document.getElementById('userName').addEventListener('keydown',function(e){ if(e.key==='Enter') document.getElementById('enterBtn').click(); });

  function enterWithName(name){
    myName=name;
    try{ localStorage.setItem('jamflow_name_'+roomId, myName); }catch(e){}
    document.getElementById('nameScreen').style.display='none';
    document.getElementById('mainScreen').style.display='flex';
    document.getElementById('userBadge').textContent='ğŸ¸ '+myName;
    buildLegend(); updateWeekNav(); buildGrid(); updateRecommend(); updateStatus(); listenFirebase();
    showToast('ğŸ‘‹ '+roomName+'ì— ì°¸ì—¬í–ˆì–´ìš”!', 2500);
  }

  function showNameScreen(){
    document.getElementById('loadingScreen').style.display='none';
    try{
      var saved=localStorage.getItem('jamflow_name_'+roomId);
      if(saved){ document.getElementById('userName').value=saved; enterWithName(saved); return; }
    }catch(e){}
    document.getElementById('nameScreen').style.display='flex';
  }
  // Firebase ì´ˆê¸°í™” + ì´ë¦„í™”ë©´ ì§„ì…
  function initFirebaseAndStart() {
    try {
      firebase.initializeApp({
        apiKey: "AIzaSyCb_CrMi2fc8qB6HvV92DDI77JDmCqGvpY",
        authDomain: "jamflow-dd033.firebaseapp.com",
        databaseURL: "https://jamflow-dd033-default-rtdb.firebaseio.com",
        projectId: "jamflow-dd033",
        storageBucket: "jamflow-dd033.firebasestorage.app",
        messagingSenderId: "913570760402",
        appId: "1:913570760402:web:18450473aa2b0a25b18f0b"
      });
      window._firebaseDb      = firebase.database();
      window._firebaseRef     = function(db, path){ return db.ref(path); };
      window._firebaseSet     = function(ref, val){ return ref.set(val); };
      window._firebaseOnValue = function(ref, cb){ ref.on('value', cb); };
    } catch(e) {
      console.log('Firebase ì—°ê²° ì‹¤íŒ¨(ë¬´ì‹œ ê°€ëŠ¥):', e);
    }
    showNameScreen();
  }

  // Firebase CDN ë¡œë“œ í›„ ì‹¤í–‰
  function loadFirebase() {
    var s1 = document.createElement('script');
    s1.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
    s1.onload = function() {
      var s2 = document.createElement('script');
      s2.src = 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
      s2.onload = initFirebaseAndStart;
      s2.onerror = showNameScreen; // Firebase ë¡œë“œ ì‹¤íŒ¨í•´ë„ ì§„í–‰
      document.head.appendChild(s2);
    };
    s1.onerror = showNameScreen; // Firebase ë¡œë“œ ì‹¤íŒ¨í•´ë„ ì§„í–‰
    document.head.appendChild(s1);
  }

  loadFirebase();
</script>



</body>
</html>