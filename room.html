<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JamFlow ğŸ¸</title>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // â˜… ì—¬ê¸°ì— ë‚˜ì¤‘ì— Firebase ì„¤ì • ë¶™ì—¬ë„£ê¸° â˜…
    const firebaseConfig = {
      apiKey: "AIzaSyCb_CrMi2fc8qB6HvV92DDI77JDmCqGvpY",
      authDomain: "jamflow-dd033.firebaseapp.com",
      databaseURL: "https://jamflow-dd033-default-rtdb.firebaseio.com",
      projectId: "jamflow-dd033",
      storageBucket: "jamflow-dd033.firebasestorage.app",
      messagingSenderId: "913570760402",
      appId: "1:913570760402:web:18450473aa2b0a25b18f0b"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ì „ì—­ìœ¼ë¡œ ë„˜ê¸°ê¸°
    window._db    = db;
    window._ref   = ref;
    window._set   = set;
    window._onValue = onValue;
    window._firebaseReady = true;
    document.dispatchEvent(new Event('firebaseReady'));
  </script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#fff; color:#111;
      font-family:'Segoe UI', sans-serif;
      min-height:100vh; display:flex;
      flex-direction:column; align-items:center;
    }
    header {
      width:100%; background:#111;
      padding:16px 24px; display:flex; align-items:center; gap:10px;
    }
    header h1 { color:#fff; font-size:1.4rem; font-weight:800; }
    header h1 span { color:#e8003a; }
    .room-name { color:#aaa; font-size:0.85rem; margin-left:4px; }

    /* ë¡œë”© */
    .loading {
      margin-top:80px;
      display:flex; flex-direction:column;
      align-items:center; gap:16px; color:#888;
    }
    .spinner {
      width:36px; height:36px;
      border:3px solid #eee;
      border-top-color:#e8003a;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ì´ë¦„ ì…ë ¥ */
    .name-screen {
      width:100%; max-width:480px;
      padding:48px 24px;
      display:none; flex-direction:column;
      align-items:center; gap:16px; text-align:center;
    }
    .name-screen h2 { font-size:1.4rem; font-weight:800; line-height:1.4; }
    .name-screen h2 span { color:#e8003a; }
    .name-screen p { font-size:0.9rem; color:#666; }
    .name-card {
      width:100%; border:2px solid #111;
      border-radius:20px; padding:24px;
      box-shadow:6px 6px 0px #111; margin-top:8px;
    }
    .name-card label { display:block; font-size:0.85rem; font-weight:600; margin-bottom:8px; }
    .name-card input {
      width:100%; padding:12px 14px;
      border:2px solid #ddd; border-radius:10px;
      font-size:1rem; background:#fafafa;
      margin-bottom:16px; transition:border-color 0.2s;
    }
    .name-card input:focus { outline:none; border-color:#e8003a; background:#fff; }

    .btn-main {
      width:100%; padding:16px;
      background:#e8003a; color:#fff;
      border:none; border-radius:12px;
      font-size:1rem; font-weight:700;
      cursor:pointer; box-shadow:4px 4px 0px #111;
      transition:transform 0.15s, box-shadow 0.15s;
    }
    .btn-main:active { transform:translate(2px,2px); box-shadow:2px 2px 0px #111; }

    /* ê·¸ë¦¬ë“œ í™”ë©´ */
    .grid-screen {
      display:none; width:100%; max-width:640px;
      padding:24px 16px 48px; flex-direction:column; gap:20px;
    }
    .grid-header { display:flex; justify-content:space-between; align-items:center; padding:0 8px; }
    .grid-header h2 { font-size:1.1rem; font-weight:800; }
    .user-badge {
      background:#111; color:#fff;
      padding:6px 12px; border-radius:20px;
      font-size:0.8rem; font-weight:700;
    }

    /* ì €ì¥ ìƒíƒœ í‘œì‹œ */
    .save-status {
      text-align:center; font-size:0.78rem;
      color:#aaa; min-height:18px;
      transition:color 0.3s;
    }
    .save-status.saving { color:#e8003a; }
    .save-status.saved  { color:#22c55e; }

    .legend { display:flex; gap:12px; align-items:center; padding:0 8px; font-size:0.8rem; color:#666; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-dot { width:13px; height:13px; border-radius:3px; border:1px solid #ddd; }

    .grid-wrap {
      overflow-x:auto;
      border:2px solid #111; border-radius:16px;
      box-shadow:4px 4px 0 #111;
    }
    .grid-table { border-collapse:collapse; min-width:100%; }
    .grid-table thead th {
      background:#111; color:#fff;
      font-size:0.75rem; font-weight:700;
      padding:10px 4px; text-align:center;
      white-space:nowrap; min-width:44px;
    }
    .grid-table thead th:first-child {
      background:#111; min-width:0; width:0; padding:0;
      position:sticky; left:0; z-index:2;
      border-right:2px solid #333;
    }
    .grid-table thead th.sat { color:#7eb8ff; }
    .grid-table thead th.sun { color:#ff7eb8; }

    .grid-table tbody td.time-label {
      background:#fafafa; font-size:0.65rem;
      color:#888; font-weight:600;
      padding:0 6px; text-align:right;
      white-space:nowrap; position:sticky;
      left:0; z-index:1;
      border-right:2px solid #ccc; vertical-align:middle;
    }
    .grid-table tbody td.cell {
      width:44px; height:16px;
      border:1px solid #eee; cursor:pointer;
      transition:background 0.05s; user-select:none;
    }
    .grid-table tbody td.cell:hover { opacity:0.8; }
    .grid-table tbody tr.on-the-hour td.cell { border-top:1px solid #ccc; }

    .status-card { border:2px solid #eee; border-radius:14px; padding:16px 20px; }
    .status-card h3 { font-size:0.9rem; font-weight:700; margin-bottom:12px; }
    .member-list { display:flex; flex-wrap:wrap; gap:8px; }
    .member-chip {
      background:#f5f5f5; border-radius:20px;
      padding:5px 12px; font-size:0.82rem; font-weight:600;
    }
    .member-chip.me { background:#fff0f3; color:#e8003a; border:1.5px solid #e8003a; }

    .btn-confirm {
      width:100%; padding:16px;
      background:#111; color:#fff;
      border:none; border-radius:12px;
      font-size:1rem; font-weight:700;
      cursor:pointer; box-shadow:4px 4px 0px #e8003a;
      transition:transform 0.15s, box-shadow 0.15s;
    }
    .btn-confirm:active { transform:translate(2px,2px); box-shadow:2px 2px 0px #e8003a; }
  </style>
</head>
<body>

  <header>
    <h1>Jam<span>Flow</span> ğŸ¸</h1>
    <span class="room-name" id="headerRoomName"></span>
  </header>

  <!-- ë¡œë”© -->
  <div class="loading" id="loadingScreen">
    <div class="spinner"></div>
    <span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
  </div>

  <!-- ì´ë¦„ ì…ë ¥ -->
  <div class="name-screen" id="nameScreen">
    <div style="font-size:3rem">ğŸµ</div>
    <h2 id="roomTitle">í•©ì£¼ ì‹œê°„ì„<br/><span>ê°™ì´ ë§ì¶°ë´ìš”</span></h2>
    <p>ë¡œê·¸ì¸ ì—†ì´ ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”</p>
    <div class="name-card">
      <label for="userName">ë‚´ ì´ë¦„ (ë‹‰ë„¤ì„)</label>
      <input type="text" id="userName" placeholder="ì˜ˆ: ê¹€ê¸°íƒ€, ë² ì´ìŠ¤ìµœ" maxlength="10"/>
      <button class="btn-main" onclick="enterRoom()">ğŸ¸ ì°¸ì—¬í•˜ê¸°</button>
    </div>
  </div>

  <!-- ê·¸ë¦¬ë“œ -->
  <div class="grid-screen" id="gridScreen">
    <div class="grid-header">
      <h2>ê°€ëŠ¥í•œ ì‹œê°„ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ìš”</h2>
      <div class="user-badge" id="userBadge"></div>
    </div>
    <div class="save-status" id="saveStatus"></div>
    <div class="legend"></div>
    <div class="grid-wrap">
      <table class="grid-table" id="gridTable"></table>
    </div>
    <div class="status-card">
      <h3>ğŸ‘¥ ì°¸ì—¬ í˜„í™© <span id="memberCount" style="color:#e8003a;"></span></h3>
      <div class="member-list" id="memberList"></div>
    </div>
    <button class="btn-confirm" onclick="alert('ë°©ì¥ì´ ìµœì¢… ë‚ ì§œë¥¼ í™•ì •í•  ìˆ˜ ìˆì–´ìš”! (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì™„ì„±)')">
      ğŸ¯ ìµœì¢… í•©ì£¼ ë‚ ì§œ í™•ì •í•˜ê¸°
    </button>
  </div>

  <script>
    const DAYS = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

    // â”€â”€ URL íŒŒë¼ë¯¸í„° â”€â”€
    const params       = new URLSearchParams(window.location.search);
    const roomId       = params.get('id')        || 'demo_room';
    const roomName     = params.get('name')      || 'í•©ì£¼ë°©';
    const startDate    = params.get('start')     || '2026-02-16';
    const endDate      = params.get('end')       || '2026-02-22';
    const startHour    = parseInt(params.get('startTime') || '9');
    const endHour      = parseInt(params.get('endTime')   || '22');
    const unitMin      = parseInt(params.get('unit')      || '30');
    const totalMembers = parseInt(params.get('members')   || '4');

    document.getElementById('headerRoomName').textContent = roomName;
    document.getElementById('roomTitle').innerHTML = `<span>${roomName}</span><br/>í•©ì£¼ ì‹œê°„ì„ ê°™ì´ ë§ì¶°ë´ìš”`;

    // â”€â”€ ë‚ ì§œ/ìŠ¬ë¡¯ ë°°ì—´ â”€â”€
    function getDates(s, e) {
      const arr = [], cur = new Date(s + 'T00:00:00');
      const end = new Date(e + 'T00:00:00');
      while (cur <= end) { arr.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
      return arr;
    }
    function getSlots(sh, eh, unit) {
      const slots = [];
      for (let h = sh; h < eh; h++)
        for (let m = 0; m < 60; m += unit)
          slots.push({ h, m });
      return slots;
    }
    const dates = getDates(startDate, endDate);
    const slots = getSlots(startHour, endHour, unitMin);

    // â”€â”€ ìƒíƒœ â”€â”€
    // selections[name] = { "di_si": true, ... }
    let selections = {};
    let myName = '';
    let isDragging = false, dragMode = null;
    let saveTimer = null;

    function cellKey(di, si) { return `${di}_${si}`; }

    function getCount(di, si) {
      const k = cellKey(di, si);
      return Object.values(selections).filter(s => s && s[k]).length;
    }
    function isMine(di, si) {
      return !!(selections[myName] && selections[myName][cellKey(di, si)]);
    }

    // â”€â”€ ìƒ‰ìƒ â”€â”€
    function cellColor(di, si) {
      const cnt = getCount(di, si);
      if (cnt === 0) return '#fff';
      if (cnt >= totalMembers) return '#e8003a';
      const r = cnt / totalMembers;
      if (r >= 0.66) return '#ff4d6d';
      if (r >= 0.33) return '#ff8099';
      return '#ffe0e6';
    }

    // â”€â”€ ë²”ë¡€ â”€â”€
    function buildLegend() {
      const m = totalMembers;
      const items = [
        { color:'#fff',    label:'ë¶ˆê°€' },
        { color:'#ffe0e6', label:'1ëª…' },
        { color:'#ff8099', label: m <= 4 ? '2ëª…' : `2~${Math.floor(m*0.66)}ëª…` },
        { color:'#ff4d6d', label: m <= 4 ? '3ëª…' : `${Math.floor(m*0.66)+1}~${m-1}ëª…` },
        { color:'#e8003a', label:`${m}ëª… ëª¨ë‘!` },
      ];
      document.querySelector('.legend').innerHTML = items.map(i =>
        `<div class="legend-item">
          <div class="legend-dot" style="background:${i.color};"></div>
          <span>${i.label}</span>
        </div>`
      ).join('');
    }

    // â”€â”€ ê·¸ë¦¬ë“œ â”€â”€
    function buildGrid() {
      const tbl = document.getElementById('gridTable');
      tbl.innerHTML = '';
      const thead = tbl.createTHead(), hrow = thead.insertRow();
      const th0 = document.createElement('th'); hrow.appendChild(th0);
      dates.forEach((d, di) => {
        const th = document.createElement('th');
        const day = d.getDay();
        th.innerHTML = `${d.getMonth()+1}/${d.getDate()}<br/>${DAYS[day]}`;
        if (day === 6) th.classList.add('sat');
        if (day === 0) th.classList.add('sun');
        hrow.appendChild(th);
      });

      const tbody = tbl.createTBody();
      slots.forEach((slot, si) => {
        const tr = tbody.insertRow();
        if (slot.m === 0) tr.classList.add('on-the-hour');
        const td0 = tr.insertCell();
        td0.className = 'time-label';
        if (slot.m === 0) {
          const h = slot.h;
          td0.textContent = h < 12 ? `ì˜¤ì „ ${h}ì‹œ` : h === 12 ? `ì˜¤í›„ 12ì‹œ` : `ì˜¤í›„ ${h-12}ì‹œ`;
        }
        dates.forEach((d, di) => {
          const td = tr.insertCell();
          td.className = 'cell';
          td.dataset.di = di; td.dataset.si = si;
          td.style.background = cellColor(di, si);
          td.addEventListener('mousedown', e => { e.preventDefault(); startDrag(di, si); });
          td.addEventListener('mouseover', () => { if (isDragging) doDrag(di, si); });
          td.addEventListener('touchstart', e => { e.preventDefault(); startDrag(di, si); }, { passive:false });
          td.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            const el = document.elementFromPoint(t.clientX, t.clientY);
            if (el && el.dataset.di !== undefined) doDrag(+el.dataset.di, +el.dataset.si);
          }, { passive:false });
        });
      });
      document.addEventListener('mouseup',  () => { if(isDragging){ isDragging=false; scheduleSave(); } });
      document.addEventListener('touchend', () => { if(isDragging){ isDragging=false; scheduleSave(); } });
    }

    function startDrag(di, si) {
      isDragging = true;
      dragMode = isMine(di, si) ? 'remove' : 'add';
      toggle(di, si);
    }
    function doDrag(di, si) {
      if (dragMode==='add'    && !isMine(di,si)) toggle(di,si);
      if (dragMode==='remove' &&  isMine(di,si)) toggle(di,si);
    }
    function toggle(di, si) {
      if (!selections[myName]) selections[myName] = {};
      const k = cellKey(di, si);
      if (dragMode === 'add') selections[myName][k] = true;
      else delete selections[myName][k];
      const td = document.querySelector(`td[data-di="${di}"][data-si="${si}"]`);
      if (td) td.style.background = cellColor(di, si);
    }

    // â”€â”€ Firebase ì €ì¥ (ë””ë°”ìš´ìŠ¤: ë“œë˜ê·¸ ëë‚˜ê³  0.5ì´ˆ í›„ ì €ì¥) â”€â”€
    function scheduleSave() {
      clearTimeout(saveTimer);
      setStatus('saving', 'ì €ì¥ ì¤‘...');
      saveTimer = setTimeout(saveToFirebase, 500);
    }

    function setStatus(type, msg) {
      const el = document.getElementById('saveStatus');
      el.textContent = msg;
      el.className = 'save-status ' + type;
    }

    function saveToFirebase() {
      if (!window._db) { updateStatus(); return; } // Firebase ë¯¸ì—°ê²° ì‹œ ìŠ¤í‚µ
      const dbRef = window._ref(window._db, `rooms/${roomId}/selections/${myName}`);
      window._set(dbRef, selections[myName] || {})
        .then(() => {
          setStatus('saved', 'âœ… ì €ì¥ëì–´ìš”!');
          setTimeout(() => setStatus('', ''), 2000);
        })
        .catch(() => setStatus('', ''));
      updateStatus();
    }

    // â”€â”€ Firebase ì‹¤ì‹œê°„ ìˆ˜ì‹  â”€â”€
    function listenFirebase() {
      if (!window._db) return;
      const dbRef = window._ref(window._db, `rooms/${roomId}/selections`);
      window._onValue(dbRef, snap => {
        const data = snap.val() || {};
        // ë‚´ ë°ì´í„°ëŠ” ë®ì–´ì“°ì§€ ì•ŠìŒ
        Object.keys(data).forEach(name => {
          if (name !== myName) selections[name] = data[name];
        });
        refreshAllCells();
        updateStatus();
      });
    }

    function refreshAllCells() {
      document.querySelectorAll('td.cell').forEach(td => {
        td.style.background = cellColor(+td.dataset.di, +td.dataset.si);
      });
    }

    // â”€â”€ ì°¸ì—¬ í˜„í™© â”€â”€
    function updateStatus() {
      const names = new Set(Object.keys(selections).filter(n => {
        const s = selections[n];
        return s && Object.keys(s).length > 0;
      }));
      document.getElementById('memberCount').textContent = `${names.size}ëª… ì°¸ì—¬ì¤‘`;
      const list = document.getElementById('memberList');
      list.innerHTML = '';
      names.forEach(n => {
        const chip = document.createElement('div');
        chip.className = 'member-chip' + (n === myName ? ' me' : '');
        chip.textContent = n === myName ? `${n} (ë‚˜)` : n;
        list.appendChild(chip);
      });
    }

    // â”€â”€ ì°¸ì—¬í•˜ê¸° â”€â”€
    function enterRoom() {
      const name = document.getElementById('userName').value.trim();
      if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      myName = name;
      document.getElementById('nameScreen').style.display  = 'none';
      document.getElementById('gridScreen').style.display  = 'flex';
      document.getElementById('userBadge').textContent = `ğŸ¸ ${myName}`;
      buildLegend();
      buildGrid();
      listenFirebase();
      updateStatus();
    }

    document.getElementById('userName').addEventListener('keydown', e => {
      if (e.key === 'Enter') enterRoom();
    });

    // â”€â”€ Firebase ì¤€ë¹„ë˜ë©´ ë¡œë”© â†’ ì´ë¦„ ì…ë ¥ í™”ë©´ ì „í™˜ â”€â”€
    function showNameScreen() {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('nameScreen').style.display    = 'flex';
    }

    if (window._firebaseReady) {
      showNameScreen();
    } else {
      document.addEventListener('firebaseReady', showNameScreen);
      // Firebase ì„¤ì • ì•ˆ ëì„ ë•Œë„ 3ì´ˆ í›„ ê·¸ëƒ¥ ì§„í–‰
      setTimeout(showNameScreen, 3000);
    }
  </script>
</body>
</html>
