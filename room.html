<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JamFlow ğŸ¸</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#fff; color:#111; font-family:'Segoe UI',sans-serif; min-height:100vh; display:flex; flex-direction:column; align-items:center; }
    header { width:100%; background:#111; padding:16px 24px; display:flex; align-items:center; gap:10px; }
    header h1 { color:#fff; font-size:1.4rem; font-weight:800; }
    header h1 span { color:#e8003a; }
    .room-name { color:#aaa; font-size:0.85rem; margin-left:4px; }
    .spinner-wrap { margin-top:80px; display:flex; flex-direction:column; align-items:center; gap:16px; color:#888; }
    .spinner { width:36px; height:36px; border:3px solid #eee; border-top-color:#e8003a; border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .name-screen { width:100%; max-width:480px; padding:48px 24px; display:none; flex-direction:column; align-items:center; gap:16px; text-align:center; }
    .name-screen h2 { font-size:1.4rem; font-weight:800; line-height:1.4; }
    .name-screen h2 span { color:#e8003a; }
    .name-screen p { font-size:0.9rem; color:#666; }
    .name-card { width:100%; border:2px solid #111; border-radius:20px; padding:24px; box-shadow:6px 6px 0px #111; margin-top:8px; }
    .name-card label { display:block; font-size:0.85rem; font-weight:600; margin-bottom:8px; }
    .name-card input { width:100%; padding:12px 14px; border:2px solid #ddd; border-radius:10px; font-size:1rem; background:#fafafa; margin-bottom:16px; }
    .name-card input:focus { outline:none; border-color:#e8003a; }
    .btn-main { width:100%; padding:16px; background:#e8003a; color:#fff; border:none; border-radius:12px; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:4px 4px 0px #111; }
    .main-screen { display:none; width:100%; max-width:640px; padding:20px 16px 60px; flex-direction:column; gap:20px; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; }
    .top-bar h2 { font-size:1rem; font-weight:800; }
    .user-badge { background:#111; color:#fff; padding:6px 12px; border-radius:20px; font-size:0.8rem; font-weight:700; }
    .week-nav { display:flex; align-items:center; justify-content:space-between; background:#f5f5f5; border-radius:12px; padding:10px 14px; }
    .week-nav .week-label { font-size:0.9rem; font-weight:700; text-align:center; flex:1; }
    .week-nav .week-label span { color:#e8003a; }
    .btn-week { background:#fff; border:2px solid #ddd; border-radius:8px; padding:6px 14px; font-size:0.85rem; font-weight:700; cursor:pointer; }
    .btn-week:disabled { opacity:0.3; cursor:default; }
    .legend { display:flex; gap:12px; align-items:center; font-size:0.8rem; color:#666; flex-wrap:wrap; }
    .legend-item { display:flex; align-items:center; gap:5px; }
    .legend-dot { width:13px; height:13px; border-radius:3px; border:1px solid #ddd; }
    /* ê·¸ë¦¬ë“œ wrap: touch-actionìœ¼ë¡œ ìŠ¤í¬ë¡¤/ë“œë˜ê·¸ ì œì–´ */
    .grid-wrap { position:relative; overflow-x:auto; border:2px solid #111; border-radius:16px; box-shadow:4px 4px 0 #111; touch-action:pan-y; }
    .grid-wrap.is-dragging { touch-action:none; }
    .grid-table { border-collapse:collapse; width:100%; }
    .grid-table thead th { background:#111; color:#fff; font-size:0.75rem; font-weight:700; padding:10px 4px; text-align:center; white-space:nowrap; }
    .grid-table thead th:first-child { width:52px; position:sticky; left:0; z-index:2; border-right:2px solid #333; }
    .grid-table thead th.sat { color:#7eb8ff; }
    .grid-table thead th.sun { color:#ff7eb8; }
    .grid-table tbody td.time-label { background:#fafafa; font-size:0.65rem; color:#888; font-weight:600; padding:0 6px; text-align:right; white-space:nowrap; position:sticky; left:0; z-index:1; border-right:2px solid #ccc; vertical-align:middle; width:52px; }
    .grid-table tbody td.cell { height:16px; border:1px solid #eee; cursor:pointer; user-select:none; }
    /* ì •ê°/30ë¶„ ëˆˆê¸ˆ */
    .grid-table tbody tr.on-the-hour td.cell { border-top:2px solid #bbb; }
    .grid-table tbody tr.half-hour td.cell { border-top:1px dashed #d0d0d0; }
    /* ì¶”ì²œë°•ìŠ¤ */
    .recommend-box { border:2px solid #111; border-radius:16px; padding:20px; box-shadow:4px 4px 0 #111; }
    .recommend-box h3 { font-size:0.95rem; font-weight:800; margin-bottom:14px; }
    .rec-card { border:2px solid #eee; border-radius:12px; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; cursor:pointer; transition:border-color 0.15s, box-shadow 0.15s; }
    .rec-card:hover { border-color:#e8003a; box-shadow:2px 2px 0 #e8003a; }
    .rec-card.top { border-color:#e8003a; background:#fff5f7; box-shadow:4px 4px 0 #111; }
    .rec-card .date-text { font-size:0.95rem; font-weight:800; }
    .rec-card .time-text { font-size:0.8rem; color:#666; margin-top:2px; }
    .badge { background:#e8003a; color:#fff; font-size:0.72rem; font-weight:800; padding:4px 10px; border-radius:20px; white-space:nowrap; }
    .badge.gray { background:#eee; color:#888; }
    .no-overlap { font-size:0.88rem; color:#aaa; text-align:center; padding:12px 0; }
    .status-card { border:2px solid #eee; border-radius:14px; padding:16px 20px; }
    .status-card h3 { font-size:0.9rem; font-weight:700; margin-bottom:12px; }
    .member-list { display:flex; flex-wrap:wrap; gap:8px; }
    .member-chip { background:#f5f5f5; border-radius:20px; padding:5px 12px; font-size:0.82rem; font-weight:600; cursor:pointer; }
    .member-chip.me { background:#fff0f3; color:#e8003a; border:1.5px solid #e8003a; cursor:default; }
    .member-chip.active { background:#111; color:#fff; }
    .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:12px 20px; border-radius:12px; font-size:0.88rem; font-weight:600; box-shadow:0 4px 16px rgba(0,0,0,0.2); opacity:0; transition:opacity 0.3s; pointer-events:none; z-index:999; white-space:nowrap; }
    .toast.show { opacity:1; }
    /* í´ë¦­ í•˜ì´ë¼ì´íŠ¸ */
    /* highlight-slot: SVG ì˜¤ë²„ë ˆì´ë¡œ ì²˜ë¦¬ */
  </style>
</head>
<body>
<header>
  <h1>Jam<span>Flow</span> ğŸ¸</h1>
  <span class="room-name" id="headerRoomName"></span>
</header>
<div class="spinner-wrap" id="loadingScreen">
  <div class="spinner"></div>
  <span>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
</div>
<div class="name-screen" id="nameScreen">
  <div style="font-size:3rem">ğŸµ</div>
  <h2 id="roomTitle">í•©ì£¼ ì‹œê°„ì„<br/><span>ê°™ì´ ë§ì¶°ë´ìš”</span></h2>
  <p>ë¡œê·¸ì¸ ì—†ì´ ì´ë¦„ë§Œ ì…ë ¥í•˜ë©´ ì°¸ì—¬í•  ìˆ˜ ìˆì–´ìš”</p>
  <div class="name-card">
    <label>ë‚´ ì´ë¦„ (ë‹‰ë„¤ì„)</label>
    <input type="text" id="userName" placeholder="ì˜ˆ: ê¹€ê¸°íƒ€, ë² ì´ìŠ¤ìµœ" maxlength="10"/>
    <button class="btn-main" id="enterBtn">ğŸ¸ ì°¸ì—¬í•˜ê¸°</button>
  </div>
</div>
<div class="main-screen" id="mainScreen">
  <div class="top-bar">
    <h2>ê°€ëŠ¥í•œ ì‹œê°„ì„ ë“œë˜ê·¸í•´ì„œ ì„ íƒí•´ìš”</h2>
    <div class="user-badge" id="userBadge"></div>
  </div>
  <div class="week-nav" id="weekNav">
    <button class="btn-week" id="prevWeekBtn">â† ì´ì „ ì£¼</button>
    <div class="week-label" id="weekLabel"></div>
    <button class="btn-week" id="nextWeekBtn">ë‹¤ìŒ ì£¼ â†’</button>
  </div>
  <div class="legend" id="legend"></div>
  <div class="grid-wrap" id="gridWrap">
    <table class="grid-table" id="gridTable"></table>
  </div>
  <div class="recommend-box">
    <h3>ğŸ† ì§€ê¸ˆ ê°€ì¥ ë§ì´ ê²¹ì¹˜ëŠ” ì‹œê°„ <span style="font-size:0.78rem;font-weight:400;color:#888;">(í´ë¦­í•˜ë©´ í•´ë‹¹ ì‹œê°„ìœ¼ë¡œ ì´ë™)</span></h3>
    <div id="recommendList"></div>
  </div>
  <div class="status-card">
    <h3>ğŸ‘¥ ì°¸ì—¬ í˜„í™© <span id="memberCount" style="color:#e8003a;"></span></h3>
    <div class="member-list" id="memberList"></div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
var DAYS_FULL=['ì¼ìš”ì¼','ì›”ìš”ì¼','í™”ìš”ì¼','ìˆ˜ìš”ì¼','ëª©ìš”ì¼','ê¸ˆìš”ì¼','í† ìš”ì¼'];
var DAYS=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
var params=new URLSearchParams(window.location.search);
var roomId=params.get('id')||'demo_room';
var roomName=params.get('name')||'í•©ì£¼ë°©';
var startDate=params.get('start')||'2026-02-16';
var endDate=params.get('end')||'2026-02-22';
var startHour=parseInt(params.get('startTime')||'9');
var endHour=parseInt(params.get('endTime')||'22');
var unitMin=parseInt(params.get('unit')||'30');
var totalMembers=parseInt(params.get('members')||'4');
var myName='';
var selections={};
var isDragging=false;
var dragMode=null;
var saveTimer=null;
var viewingMember=null;
var currentWeek=0;

document.getElementById('headerRoomName').textContent=roomName;
document.getElementById('roomTitle').innerHTML='<span>'+roomName+'</span><br/>í•©ì£¼ ì‹œê°„ì„ ê°™ì´ ë§ì¶°ë´ìš”';

/* â”€â”€ ìŠ¤í† ë¦¬ì§€: localStorage > sessionStorage > ë©”ëª¨ë¦¬ (ì¹´ì¹´ì˜¤ ë¸Œë¼ìš°ì € ëŒ€ì‘) â”€â”€ */
var _storage=(function(){
  try{localStorage.setItem('__t__','1');localStorage.removeItem('__t__');return localStorage;}catch(e){}
  try{sessionStorage.setItem('__t__','1');sessionStorage.removeItem('__t__');return sessionStorage;}catch(e){}
  var m={};
  return{getItem:function(k){return m[k]||null;},setItem:function(k,v){m[k]=v;},removeItem:function(k){delete m[k];}};
})();

function getDates(s,e){
  var arr=[],cur=new Date(s+'T00:00:00'),end=new Date(e+'T00:00:00');
  while(cur<=end){arr.push(new Date(cur));cur.setDate(cur.getDate()+1);}
  return arr;
}
function splitWeeks(dates){
  var weeks=[],week=[];
  for(var i=0;i<dates.length;i++){
    week.push(dates[i]);
    if(week.length===7||i===dates.length-1){weeks.push(week);week=[];}
  }
  return weeks;
}
function getSlots(sh,eh,unit){
  var arr=[];
  for(var h=sh;h<eh;h++)for(var m=0;m<60;m+=unit)arr.push({h:h,m:m});
  return arr;
}

var allDates=getDates(startDate,endDate);
var weeks=splitWeeks(allDates);
var slots=getSlots(startHour,endHour,unitMin);

function cellKey(di,si){return di+'_'+si;}
function getCount(di,si){
  var k=cellKey(di,si),cnt=0,names=Object.keys(selections);
  for(var i=0;i<names.length;i++)if(selections[names[i]]&&selections[names[i]][k])cnt++;
  return cnt;
}
function isMine(di,si){return !!(selections[myName]&&selections[myName][cellKey(di,si)]);}

function othersColor(cnt){
  if(cnt===0)return '#fff';
  var r=cnt/totalMembers;
  if(r>=0.66)return '#bbb';
  if(r>=0.33)return '#d5d5d5';
  return '#eee';
}
function cellColor(di,si){
  var cnt=getCount(di,si);
  if(cnt===0)return '#fff';
  var mine=isMine(di,si);
  var others=cnt-(mine?1:0);
  if(mine&&others>0){
    var r=cnt/totalMembers;
    if(r>=0.66)return '#ff4d6d';
    if(r>=0.33)return '#ff8099';
    return '#ffb3c1';
  }
  if(mine)return '#ffe0e6';
  return othersColor(others);
}

function timeLabel(h,m){
  var ap=h<12?'ì˜¤ì „':'ì˜¤í›„';
  var hh=h===0?12:h>12?h-12:h;
  return m===0?ap+' '+hh+'ì‹œ':ap+' '+hh+'ì‹œ '+m+'ë¶„';
}

var toastTimer=null;
function showToast(msg,dur){
  var el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(function(){el.classList.remove('show');},dur||2000);
}

function buildLegend(){
  var m=totalMembers;
  var items=[
    {color:'#fff',label:'ë¶ˆê°€'},
    {color:'#ffe0e6',label:'ë‚´ ì„ íƒ'},
    {color:'#eee',label:'ë‹¤ë¥¸ì‚¬ëŒ'},
    {color:'#ff8099',label:'ê²¹ì¹¨'},
    {color:'#e8003a',label:'ì „ì› ê°€ëŠ¥!'}
  ];
  var html='';
  for(var i=0;i<items.length;i++)
    html+='<div class="legend-item"><div class="legend-dot" style="background:'+items[i].color+'"></div><span>'+items[i].label+'</span></div>';
  document.getElementById('legend').innerHTML=html;
}

function updateWeekNav(){
  var w=weeks[currentWeek];
  var first=w[0],last=w[w.length-1];
  var label=(first.getMonth()+1)+'ì›” '+first.getDate()+'ì¼ ~ '+(last.getMonth()+1)+'ì›” '+last.getDate()+'ì¼';
  if(weeks.length>1)label+=' <span>('+(currentWeek+1)+'/'+weeks.length+'ì£¼)</span>';
  document.getElementById('weekLabel').innerHTML=label;
  document.getElementById('prevWeekBtn').disabled=currentWeek===0;
  document.getElementById('nextWeekBtn').disabled=currentWeek===weeks.length-1;
  document.getElementById('weekNav').style.display=weeks.length<=1?'none':'flex';
}

/* â”€â”€ [FIX1] mine ì™¸ê³½ í…Œë‘ë¦¬: SVG ì˜¤ë²„ë ˆì´ â”€â”€ */
function drawMineOutline(){
  var old=document.getElementById('mineOverlay');
  if(old)old.remove();
  var wrap=document.getElementById('gridWrap');
  var tbl=document.getElementById('gridTable');
  if(!tbl)return;
  var cells=tbl.querySelectorAll('td.cell');
  if(!cells.length)return;

  /* mine ì…€ ì§‘í•© */
  var mineMap={};
  cells.forEach(function(td){
    var di=parseInt(td.dataset.di),si=parseInt(td.dataset.si);
    if(isMine(di,si))mineMap[di+'_'+si]=td;
  });
  if(Object.keys(mineMap).length===0)return;

  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.id='mineOverlay';
  svg.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:4;overflow:visible;';

  var wrapRect=wrap.getBoundingClientRect();
  Object.keys(mineMap).forEach(function(key){
    var td=mineMap[key];
    var parts=key.split('_');
    var di=parseInt(parts[0]),si=parseInt(parts[1]);
    var rect=td.getBoundingClientRect();
    var x=rect.left-wrapRect.left+wrap.scrollLeft;
    var y=rect.top-wrapRect.top+wrap.scrollTop;
    var w=rect.width,h=rect.height;
    var neighbors=[
      {nk:di+'_'+(si-1),x1:x,y1:y,x2:x+w,y2:y},
      {nk:di+'_'+(si+1),x1:x,y1:y+h,x2:x+w,y2:y+h},
      {nk:(di-1)+'_'+si,x1:x,y1:y,x2:x,y2:y+h},
      {nk:(di+1)+'_'+si,x1:x+w,y1:y,x2:x+w,y2:y+h}
    ];
    neighbors.forEach(function(nb){
      if(!mineMap[nb.nk]){
        var line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',nb.x1);line.setAttribute('y1',nb.y1);
        line.setAttribute('x2',nb.x2);line.setAttribute('y2',nb.y2);
        line.setAttribute('stroke','#e8003a');
        line.setAttribute('stroke-width','2.5');
        line.setAttribute('stroke-linecap','square');
        svg.appendChild(line);
      }
    });
  });
  wrap.appendChild(svg);
}

/* ì¶”ì²œ ì¹´ë“œ í´ë¦­ ì‹œ í•´ë‹¹ ë¸”ë¡ ì „ì²´ ì™¸ê³½ì„  (ë…¸ë€ìƒ‰ SVG) */
function drawHighlightOutline(di, siStart, siEnd){
  removeHighlightOutline();
  var wrap=document.getElementById('gridWrap');
  var tbl=document.getElementById('gridTable');
  if(!tbl)return;

  /* í•´ë‹¹ ë²”ìœ„ ì…€ ìˆ˜ì§‘ */
  var cellMap={};
  for(var s=siStart;s<=siEnd;s++){
    var td=tbl.querySelector('td[data-di="'+di+'"][data-si="'+s+'"]');
    if(td)cellMap[di+'_'+s]=td;
  }
  if(Object.keys(cellMap).length===0)return;

  var svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.id='highlightOverlay';
  svg.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;overflow:visible;';

  var wrapRect=wrap.getBoundingClientRect();
  Object.keys(cellMap).forEach(function(key){
    var td=cellMap[key];
    var parts=key.split('_');
    var cdi=parseInt(parts[0]),csi=parseInt(parts[1]);
    var rect=td.getBoundingClientRect();
    var x=rect.left-wrapRect.left+wrap.scrollLeft;
    var y=rect.top-wrapRect.top+wrap.scrollTop;
    var w=rect.width,h=rect.height;
    var neighbors=[
      {nk:cdi+'_'+(csi-1),x1:x,y1:y,x2:x+w,y2:y},
      {nk:cdi+'_'+(csi+1),x1:x,y1:y+h,x2:x+w,y2:y+h},
      {nk:(cdi-1)+'_'+csi,x1:x,y1:y,x2:x,y2:y+h},
      {nk:(cdi+1)+'_'+csi,x1:x+w,y1:y,x2:x+w,y2:y+h}
    ];
    neighbors.forEach(function(nb){
      if(!cellMap[nb.nk]){
        var line=document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',nb.x1);line.setAttribute('y1',nb.y1);
        line.setAttribute('x2',nb.x2);line.setAttribute('y2',nb.y2);
        line.setAttribute('stroke','#ffd600');
        line.setAttribute('stroke-width','3');
        line.setAttribute('stroke-linecap','square');
        svg.appendChild(line);
      }
    });
  });
  wrap.appendChild(svg);
}

function removeHighlightOutline(){
  var old=document.getElementById('highlightOverlay');
  if(old)old.remove();
}

function buildGrid(){
  var w=weeks[currentWeek];
  var weekStartDi=0;
  for(var i=0;i<allDates.length;i++){
    if(allDates[i].getTime()===w[0].getTime()){weekStartDi=i;break;}
  }
  var tbl=document.getElementById('gridTable');
  tbl.innerHTML='';
  var thead=tbl.createTHead(),hrow=thead.insertRow();
  var th0=document.createElement('th');hrow.appendChild(th0);
  for(var di=0;di<w.length;di++){
    var d=w[di],day=d.getDay();
    var th=document.createElement('th');
    th.innerHTML=(d.getMonth()+1)+'/'+(d.getDate())+'<br/>'+DAYS[day];
    if(day===6)th.classList.add('sat');
    if(day===0)th.classList.add('sun');
    hrow.appendChild(th);
  }
  var tbody=tbl.createTBody();
  for(var si=0;si<slots.length;si++){
    var slot=slots[si];
    var tr=tbody.insertRow();
    /* [FIX2] 15ë¶„ ë‹¨ìœ„ë©´ 30ë¶„ ëˆˆê¸ˆë„ í‘œì‹œ */
    if(slot.m===0){
      tr.classList.add('on-the-hour');
    } else if(unitMin===15&&slot.m===30){
      tr.classList.add('half-hour');
    }
    var td0=tr.insertCell();td0.className='time-label';
    if(slot.m===0){
      td0.textContent=timeLabel(slot.h,0);
    } else if(unitMin===15&&slot.m===30){
      td0.textContent=':30';
      td0.style.fontSize='0.6rem';
      td0.style.color='#bbb';
    }
    for(var di2=0;di2<w.length;di2++){
      var realDi=weekStartDi+di2;
      var td=tr.insertCell();
      td.className='cell';
      td.dataset.di=realDi;td.dataset.si=si;
      td.style.background=cellColor(realDi,si);
      (function(rdi,sii){
        td.addEventListener('mousedown',function(e){e.preventDefault();startDrag(rdi,sii);});
        td.addEventListener('mouseover',function(){if(isDragging)doDrag(rdi,sii);});
        /* [FIX4] í„°ì¹˜: ì…€ì—ì„œë§Œ ë“œë˜ê·¸ ì‹œì‘ */
        td.addEventListener('touchstart',function(e){
          startDrag(rdi,sii);
          document.getElementById('gridWrap').classList.add('is-dragging');
          e.preventDefault();
        },{passive:false});
        td.addEventListener('touchmove',function(e){
          if(!isDragging)return;
          e.preventDefault();
          var t=e.touches[0];
          var el=document.elementFromPoint(t.clientX,t.clientY);
          if(el&&el.dataset&&el.dataset.di!==undefined)doDrag(parseInt(el.dataset.di),parseInt(el.dataset.si));
        },{passive:false});
      })(realDi,si);
    }
  }
  setTimeout(drawMineOutline,60);
}

document.addEventListener('mouseup',function(){
  if(isDragging){isDragging=false;scheduleSave();updateRecommend();updateStatus();drawMineOutline();}
});
document.addEventListener('touchend',function(){
  if(isDragging){
    isDragging=false;
    document.getElementById('gridWrap').classList.remove('is-dragging');
    scheduleSave();updateRecommend();updateStatus();drawMineOutline();
  }
});

function startDrag(di,si){isDragging=true;dragMode=isMine(di,si)?'remove':'add';toggle(di,si);}
function doDrag(di,si){
  if(dragMode==='add'&&!isMine(di,si))toggle(di,si);
  if(dragMode==='remove'&&isMine(di,si))toggle(di,si);
}
function toggle(di,si){
  if(!selections[myName])selections[myName]={};
  var k=cellKey(di,si);
  if(dragMode==='add')selections[myName][k]=true;
  else delete selections[myName][k];
  var td=document.querySelector('td[data-di="'+di+'"][data-si="'+si+'"]');
  if(td)td.style.background=cellColor(di,si);
  updateRecommend();
}

document.getElementById('prevWeekBtn').addEventListener('click',function(){
  if(currentWeek>0){currentWeek--;updateWeekNav();buildGrid();}
});
document.getElementById('nextWeekBtn').addEventListener('click',function(){
  if(currentWeek<weeks.length-1){currentWeek++;updateWeekNav();buildGrid();}
});

/* â”€â”€ [FIX3+5] ì¶”ì²œ: ê·¸ë¦¬ë“œ ì•„ë˜ ìœ„ì¹˜, í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤+í•˜ì´ë¼ì´íŠ¸ â”€â”€ */
function updateRecommend(){
  var scored=[];
  for(var di=0;di<allDates.length;di++)
    for(var si=0;si<slots.length;si++){
      var cnt=getCount(di,si);
      if(cnt>0)scored.push({di:di,si:si,cnt:cnt,endSi:si});
    }
  scored.sort(function(a,b){return b.cnt-a.cnt;});
  var groups=[];
  for(var i=0;i<Math.min(scored.length,30);i++){
    var item=scored[i],last=groups[groups.length-1];
    if(last&&last.di===item.di&&item.si===last.endSi+1&&item.cnt===last.cnt)last.endSi=item.si;
    else groups.push({di:item.di,si:item.si,endSi:item.si,cnt:item.cnt});
  }
  groups=groups.slice(0,3);
  var list=document.getElementById('recommendList');
  if(groups.length===0){list.innerHTML='<div class="no-overlap">ì•„ì§ ì•„ë¬´ë„ ì„ íƒí•˜ì§€ ì•Šì•˜ì–´ìš”</div>';return;}
  list.innerHTML='';
  for(var j=0;j<groups.length;j++){
    (function(g,idx){
      var d=allDates[g.di];
      var dateStr=(d.getMonth()+1)+'ì›” '+d.getDate()+'ì¼ '+DAYS_FULL[d.getDay()];
      var startT=timeLabel(slots[g.si].h,slots[g.si].m);
      var nsi=g.endSi+1;
      var endT=nsi<slots.length?timeLabel(slots[nsi].h,slots[nsi].m):timeLabel(slots[g.endSi].h,slots[g.endSi].m+unitMin);
      var card=document.createElement('div');
      card.className='rec-card'+(idx===0?' top':'');
      card.innerHTML='<div><div class="date-text">'+(idx===0?'ğŸ‘‘ ':'')+dateStr+'</div><div class="time-text">'+startT+' ~ '+endT+'</div></div>'
        +'<div class="badge '+(idx===0?'':'gray')+'">'+g.cnt+'ëª…'+(g.cnt>=totalMembers?' ğŸ‰':'')+'</div>';
      card.addEventListener('click',function(){
        /* í•´ë‹¹ ì£¼ë¡œ ì´ë™ */
        var targetWeek=-1;
        outer:for(var wi=0;wi<weeks.length;wi++){
          var wk=weeks[wi],offset=0;
          for(var ai=0;ai<allDates.length;ai++){
            if(allDates[ai].getTime()===wk[0].getTime()){offset=ai;break;}
          }
          for(var wdi=0;wdi<wk.length;wdi++){
            if(offset+wdi===g.di){targetWeek=wi;break outer;}
          }
        }
        if(targetWeek!==-1&&targetWeek!==currentWeek){
          currentWeek=targetWeek;updateWeekNav();buildGrid();
        }
        /* í•˜ì´ë¼ì´íŠ¸: SVG ì™¸ê³½ì„ ìœ¼ë¡œ ì „ì²´ ë¸”ë¡ í…Œë‘ë¦¬ */
        setTimeout(function(){
          drawHighlightOutline(g.di, g.si, g.endSi);
          /* í•´ë‹¹ ë²”ìœ„ ì…€ ë°°ê²½ ë…¸ë€ìƒ‰ìœ¼ë¡œ */
          var _highlighted=[];
          for(var _s=g.si;_s<=g.endSi;_s++){
            var _td=document.querySelector('td[data-di="'+g.di+'"][data-si="'+_s+'"]');
            if(_td){_highlighted.push({el:_td,orig:_td.style.background});_td.style.background='rgba(255,214,0,0.35)';}
          }
          var firstCell=document.querySelector('td[data-di="'+g.di+'"][data-si="'+g.si+'"]');
          if(firstCell)firstCell.scrollIntoView({behavior:'smooth',block:'center'});
          setTimeout(function(){
            removeHighlightOutline();
            _highlighted.forEach(function(item){item.el.style.background=item.orig;});
          },2500);
        },50);
        showToast('ğŸ“ í•´ë‹¹ ì‹œê°„ëŒ€ë¡œ ì´ë™í–ˆì–´ìš”!',1500);
      });
      list.appendChild(card);
    })(groups[j],j);
  }
}

function refreshAllCells(){
  var cells=document.querySelectorAll('td.cell');
  for(var i=0;i<cells.length;i++){
    var di=parseInt(cells[i].dataset.di),si=parseInt(cells[i].dataset.si);
    if(viewingMember){
      var sel=selections[viewingMember];
      cells[i].style.background=(sel&&sel[cellKey(di,si)])?'#e8003a':'#fff';
    } else {
      cells[i].style.background=cellColor(di,si);
    }
  }
  drawMineOutline();
}

function updateStatus(){
  var names=Object.keys(selections).filter(function(n){var s=selections[n];return s&&Object.keys(s).length>0;});
  document.getElementById('memberCount').textContent=names.length+'ëª… ì°¸ì—¬ì¤‘';
  var html='';
  for(var i=0;i<names.length;i++){
    var n=names[i],isMe=n===myName,isActive=viewingMember===n;
    html+='<div class="member-chip'+(isMe?' me':isActive?' active':'')+'" data-name="'+n+'">'+n+(isMe?' (ë‚˜)':'')+'</div>';
  }
  document.getElementById('memberList').innerHTML=html;
  document.getElementById('memberList').onclick=function(e){
    var chip=e.target.closest('.member-chip');
    if(!chip||chip.classList.contains('me'))return;
    var name=chip.dataset.name;
    viewingMember=(viewingMember===name)?null:name;
    showToast(viewingMember?'ğŸ‘€ '+viewingMember+'ì˜ ìŠ¤ì¼€ì¤„ ë³´ëŠ” ì¤‘':'ì „ì²´ ë³´ê¸°ë¡œ ëŒì•„ì™”ì–´ìš”',1500);
    refreshAllCells();updateStatus();
  };
}

/* â”€â”€ [FIX6] Firebase ì €ì¥: compat v9 í†µì¼, ë‚´ ë°ì´í„° ë³µì› â”€â”€ */
function scheduleSave(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(saveToFirebase,1500);
}
function saveToFirebase(){
  if(window._db){
    window._db.ref('rooms/'+roomId+'/selections/'+myName)
      .set(selections[myName]||{})
      .then(function(){showToast('âœ… ì €ì¥ëì–´ìš”!');})
      .catch(function(e){console.error(e);showToast('âš ï¸ ì €ì¥ ì‹¤íŒ¨');});
  } else {
    showToast('âœ… ì €ì¥ëì–´ìš”! (ì˜¤í”„ë¼ì¸)');
  }
  updateStatus();
}

function listenFirebase(){
  if(!window._db)return;
  window._db.ref('rooms/'+roomId).on('value',function(snap){
    var data=snap.val()||{};
    var remote=data.selections||{};
    Object.keys(remote).forEach(function(name){
      if(name!==myName)selections[name]=remote[name];
    });
    refreshAllCells();updateStatus();updateRecommend();
  });
}

function enterWithName(name){
  myName=name;
  try{_storage.setItem('jamflow_name_'+roomId,myName);}catch(e){}
  document.getElementById('nameScreen').style.display='none';
  document.getElementById('mainScreen').style.display='flex';
  document.getElementById('userBadge').textContent='ğŸ¸ '+myName;
  if(window._db){
    /* ë‚´ ê¸°ì¡´ ì„ íƒ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸° */
    window._db.ref('rooms/'+roomId+'/selections/'+myName).once('value',function(snap){
      var saved=snap.val();
      if(saved&&Object.keys(saved).length>0){
        selections[myName]=saved;
        showToast('ğŸ’¾ ì´ì „ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ì–´ìš”!',2000);
      }
      buildLegend();updateWeekNav();buildGrid();updateRecommend();updateStatus();
      listenFirebase();
    });
  } else {
    buildLegend();updateWeekNav();buildGrid();updateRecommend();updateStatus();
    showToast('ğŸ‘‹ '+roomName+'ì— ì°¸ì—¬í–ˆì–´ìš”!',2000);
  }
}

document.getElementById('enterBtn').addEventListener('click',function(){
  var name=document.getElementById('userName').value.trim();
  if(!name){alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');return;}
  enterWithName(name);
});
document.getElementById('userName').addEventListener('keydown',function(e){
  if(e.key==='Enter')document.getElementById('enterBtn').click();
});

function showNameScreen(){
  document.getElementById('loadingScreen').style.display='none';
  var saved=null;
  try{saved=_storage.getItem('jamflow_name_'+roomId);}catch(e){}
  if(saved){enterWithName(saved);return;}
  document.getElementById('nameScreen').style.display='flex';
}

/* â”€â”€ Firebase compat v9 ë¡œë“œ (ì¹´ì¹´ì˜¤ ë¸Œë¼ìš°ì € í˜¸í™˜, ESM ë¯¸ì‚¬ìš©) â”€â”€ */
function loadFirebase(){
  var s1=document.createElement('script');
  s1.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js';
  s1.onload=function(){
    var s2=document.createElement('script');
    s2.src='https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js';
    s2.onload=function(){
      try{
        var existingApp;
        try{existingApp=firebase.app();}catch(e){}
        if(!existingApp){
          firebase.initializeApp({
            apiKey:"AIzaSyCb_CrMi2fc8qB6HvV92DDI77JDmCqGvpY",
            authDomain:"jamflow-dd033.firebaseapp.com",
            databaseURL:"https://jamflow-dd033-default-rtdb.firebaseio.com",
            projectId:"jamflow-dd033",
            storageBucket:"jamflow-dd033.firebasestorage.app",
            messagingSenderId:"913570760402",
            appId:"1:913570760402:web:18450473aa2b0a25b18f0b"
          });
        }
        window._db=firebase.database();
      }catch(e){console.log('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:',e);}
      showNameScreen();
    };
    s2.onerror=showNameScreen;
    document.head.appendChild(s2);
  };
  s1.onerror=showNameScreen;
  document.head.appendChild(s1);
}
loadFirebase();
</script>
</body>
</html>
